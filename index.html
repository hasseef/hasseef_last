<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ููุตุฉ ุญุตูู ุงููุทููุฉ ููุชูุงูู ุงูุชูููู</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config={theme:{extend:{colors:{
 brand:{50:'#eefdfb',100:'#cff7f3',200:'#a0eee6',300:'#6de2d8',400:'#36d0c7',500:'#0ea5a4',600:'#0f8f8d',700:'#0f766e',800:'#0b5953',900:'#083f3a'},
 gov:{50:'#eff6ff',100:'#dbeafe',300:'#93c5fd',500:'#2563eb',600:'#1d4ed8',700:'#1e40af'},
 steel:{50:'#f8fafc',100:'#f1f5f9',200:'#e2e8f0',300:'#cbd5e1',500:'#64748b',700:'#334155',900:'#0f172a'}
},fontFamily:{sans:['Tajawal','ui-sans-serif','system-ui']}}},darkMode:['class','[data-theme="dark"]']};
</script>
<style>
:root{--brand:#0ea5a4;--gov:#2563eb}
*{box-sizing:border-box} body{font-family:'Tajawal',system-ui}
.section{scroll-margin-top:84px}
.card{border:1px solid #e2e8f0;background:#fff;border-radius:1.25rem}
.badge{font-size:.72rem;border-radius:999px;background:#ecfeff;color:#065f46;padding:.15rem .6rem;border:1px solid #99f6e4}
.kpi{border:1px solid #e2e8f0;background:#fff;border-radius:1rem;padding:.7rem}
.kpi-label{font-size:.7rem;color:#64748b}.kpi-value{margin-top:.1rem;font-size:1.4rem;font-weight:900;color:#047857}
.btn{padding:.55rem .9rem;border-radius:.9rem;border:1px solid #e2e8f0;background:#fff}
.btn-primary{background:var(--brand);color:#fff;border-color:var(--brand)}
.btn-gov{background:var(--gov);color:#fff;border-color:var(--gov)}
.nav-pill{padding:.45rem .8rem;border-radius:999px;border:1px solid #e2e8f0;background:#fff}
.nav-pill[aria-current="page"]{background:var(--brand);color:#fff;border-color:var(--brand)}
.action{font-size:.75rem}.action.edit{color:#1d4ed8}.action.del{color:#b91c1c}
.smart-chip{display:inline-flex;gap:.3rem;align-items:center;border-radius:999px;border:1px dashed #94a3b8;padding:.15rem .5rem;font-size:.72rem;color:#334155;background:#f8fafc}
.logo{height:32px}.glass{backdrop-filter:saturate(160%) blur(8px);background:rgba(255,255,255,.72)}
.field{display:flex;flex-direction:column;gap:.35rem}.input{border:1px solid #e2e8f0;border-radius:.9rem;padding:.7rem .9rem;background:#fff}
.checkbox{width:1rem;height:1rem;border:1px solid #cbd5e1;border-radius:.4rem}

/* ุณููู ุงูุนุฑุถ ุงูุญูููู */
:root[data-variant="gov"]{--brand:#0ea5a4;--gov:#2563eb}
[data-variant="gov"] .nav-pill[aria-current="page"],[data-variant="gov"] .btn-primary{background:var(--gov);border-color:var(--gov)}
[data-variant="gov"] .badge{background:#eef2ff;border-color:#c7d2fe;color:#1e40af}
[data-variant="gov"] header .ribbon{background:linear-gradient(90deg,#1e40af,#2563eb);color:#fff;font-weight:800;letter-spacing:.5px}
[data-variant="gov"] header .ribbon small{opacity:.9;font-weight:600}
[data-variant="gov"] .card{border-color:#dbeafe}
[data-variant="gov"] .kpi-value{color:#1e40af}
[data-variant="gov"] #consoleBar .glass{border-color:#bfdbfe}
</style>
</head>
<body class="bg-steel-50 text-steel-900" data-variant="gov">

<!-- HEADER -->
<header class="pt-6 pb-4">
  <div class="mx-auto max-w-6xl px-4">
    <div class="flex items-center justify-between gap-3">
      <div class="flex items-center gap-2">
        <!-- ูุณุงุฑ: ุฑุคูุฉ + ุชูุจูุฉ -->
        <img class="logo" alt="Vision 2030"
          src='data:image/svg+xml;utf8,<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" width="200" height="60"><rect width="200" height="60" rx="8" fill="%23eef2ff"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="Tajawal,Arial" font-weight="700" font-size="18" fill="%231e40af">VISION 2030</text></svg>'/>
        <img class="logo" alt="Talbiya"
          src='data:image/svg+xml;utf8,<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" width="180" height="60"><rect width="180" height="60" rx="8" fill="%23ecfeff"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="Tajawal,Arial" font-weight="700" font-size="18" fill="%230f766e">TALBIYA</text></svg>'/>
      </div>
      <div class="flex items-center gap-2">
        <!-- ูููู: ุดุนุงุฑ ุญุตูู -->
        <img class="logo" alt="Hasseef"
          src='data:image/svg+xml;utf8,<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" width="180" height="60"><rect width="180" height="60" rx="8" fill="%23d1fae5"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="Tajawal,Arial" font-weight="900" font-size="20" fill="%23047557">ุญูุตูููู</text></svg>'/>
      </div>
    </div>

    <!-- ุดุฑูุท ุนุฑุถ ุญูููู ุฑุณูู -->
    <div class="ribbon mt-3 rounded-2xl px-4 py-2 flex items-center justify-between shadow">
      <div class="flex items-center gap-3">
        <span>๐ ุนุฑุถ ุญูููู ุฑุณูู</span>
        <small>ูุณุฎุฉ ูููููุฃุฉ ููุนุฑูุถ ุฃูุงู ุงูุฌูุงุช ุงูุนููุง</small>
      </div>
      <img class="logo" alt="Hasseef"
        src='data:image/svg+xml;utf8,<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" width="180" height="60"><rect width="180" height="60" rx="8" fill="%23d1fae5"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="Tajawal,Arial" font-weight="900" font-size="20" fill="%23047557">ุญูุตูููู</text></svg>'/>
    </div>

    <div class="mt-4 flex items-center justify-between gap-3">
      <nav class="flex items-center gap-2 text-sm">
        <a href="#login" class="nav-pill" data-nav="login">ุงูุฏุฎูู</a>
        <a href="#docs" class="nav-pill" data-nav="docs">ุงููุซุงุฆู</a>
        <a href="#map" class="nav-pill" data-nav="map">ุงูุฎุฑูุทุฉ</a>
      </nav>
      <div class="flex items-center gap-2">
        <button id="toggleDark" class="btn">ูุถุน ุฏุงูู</button>
        <button id="toggleGov" class="btn">ูุถุน ุญูููู</button>
        <button id="logoutBtn" class="btn hidden">ุชุณุฌูู ุฎุฑูุฌ</button>
      </div>
    </div>
  </div>
</header>

<!-- LOGIN -->
<section id="view-login" class="section">
  <div class="mx-auto max-w-3xl px-4">
    <div class="card p-6 lg:p-8 shadow-md">
      <h1 class="text-2xl lg:text-3xl font-black">ุชุณุฌูู ุงูุฏุฎูู ุฅูู ููุตุฉ ุญุตูู</h1>
      <p class="mt-2 text-steel-700">ูุณุฎุฉ ุชุฌุฑูุจูุฉ ูุญููุฉ โ ูุง ุชูุฑุณู ุฃู ุจูุงูุงุช ูุฎุงุฏู. ููุนุฑุถ ููุท.</p>
      <form id="loginForm" class="mt-6 grid md:grid-cols-2 gap-4">
        <div class="field md:col-span-1">
          <label class="text-sm font-semibold">ุงุณู ุงููุณุชุฎุฏู</label>
          <input id="fUser" type="text" class="input" placeholder="example@domain.sa" required />
        </div>
        <div class="field md:col-span-1">
          <label class="text-sm font-semibold">ูููุฉ ุงููุฑูุฑ</label>
          <input id="fPass" type="password" class="input" placeholder="โขโขโขโขโขโขโขโข" required />
        </div>
        <div class="field md:col-span-2">
          <label class="text-sm font-semibold">ุงุฎุชูุงุฑ ุงูุญุณุงุจ</label>
          <select id="fAccount" class="input"></select>
        </div>
        <div class="md:col-span-2 flex items-center justify-between">
          <label class="flex items-center gap-2 text-sm text-steel-700"><input id="fRemember" type="checkbox" class="checkbox"/> ุชุฐููุฑูู</label>
          <button class="btn btn-primary" type="submit">ุฏุฎูู</button>
        </div>
      </form>
      <div id="loginMsg" class="mt-3 text-sm text-red-700 hidden">ุชุญูู ูู ุงูุจูุงูุงุช.</div>
    </div>
  </div>
</section>

<!-- HOME: ุงุฎุชูุงุฑ ุงูุญุณุงุจ -->
<section id="view-home" class="section hidden">
  <div class="mx-auto max-w-6xl px-4">
    <div class="card p-5 lg:p-6 shadow-md">
      <div class="flex items-start justify-between gap-3">
        <div>
          <h2 class="text-2xl lg:text-3xl font-black">ุงุฎุชุฑ ุญุณุงุจูุง ููุนุฑุถ</h2>
          <p class="mt-2 text-steel-700">ุงูุชูู ุฅูู ููุญุงุช ุงูุญุณุงุจุงุช ุจุฎุฏูุงุช ูุงููุฉ ูุตูุงุญูุงุช ููุนููุฉ.</p>
        </div>
      </div>
      <div id="accountGrid" class="mt-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </div>
  </div>
</section>

<!-- DASHBOARD -->
<section id="view-dashboard" class="section hidden">
  <div class="mx-auto max-w-6xl px-4">
    <div class="flex items-center justify-between">
      <div>
        <h2 id="dashTitle" class="text-xl lg:text-2xl font-extrabold">ููุญุฉ ุญุณุงุจ โ</h2>
        <p id="dashLead" class="text-steel-600 mt-1">ุณุฌูุงุช ูุฎุฏูุงุช ูุชูุงููุฉ + ุทุจูุฉ ุฐูุงุก ูุญููุฉ.</p>
      </div>
      <div class="flex items-center gap-2">
        <a href="#home" class="btn">โฌ ุชุบููุฑ ุงูุญุณุงุจ</a>
        <button id="printBtn" class="btn btn-primary">ุชูุฑูุฑ PDF</button>
      </div>
    </div>
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mt-5">
      <div class="kpi"><div class="kpi-label">ูุจุงุฏุฑุงุช/ูุดุงุฑูุน</div><div id="kpiInits" class="kpi-value">0</div></div>
      <div class="kpi"><div class="kpi-label">ุณุฌูุงุช</div><div id="kpiOps" class="kpi-value">0</div></div>
      <div class="kpi"><div class="kpi-label">ุงูุฑุตูุฏ</div><div id="kpiBal" class="kpi-value">0</div></div>
      <div class="kpi"><div class="kpi-label">ูุคุดุฑ ุงูุฃุซุฑ</div><div id="kpiImpact" class="kpi-value">0</div></div>
    </div>
    <div class="mt-6 flex flex-wrap gap-2" id="tabs"></div>
    <div id="panels" class="mt-4"></div>
  </div>
</section>

<!-- DOCS -->
<section id="view-docs" class="section hidden">
  <div class="mx-auto max-w-6xl px-4">
    <div class="card p-5 lg:p-6 shadow-md">
      <div class="flex items-start justify-between gap-3">
        <div>
          <h2 class="text-2xl font-black">ุงููุซุงุฆู ูุงูุนููุฏ</h2>
          <p class="mt-2 text-steel-600 text-sm">ุชุฑุชูุจ ุงููุฑุงุกุฉ: ุงูุญุฒูุฉ ุงููุฏูุฌุฉ ุฃูููุง ุซู ููู JSON ุฎุงุฑุฌู (ุฅู ููุฌุฏ).</p>
        </div>
      </div>
      <div class="mt-4 grid grid-cols-1 gap-2">
        <!-- ุงุฑูุน ูููุงุชู ุจุฃุณูุงุฆูุง ุงูููุงุฆูุฉ ุจุฌูุงุฑ index.html ุฃู ุนุฏูู ุงูุฑูุงุจุท ุฃุฏูุงู -->
        <a class="flex items-center justify-between rounded-xl border border-slate-200 bg-white px-4 py-3 hover:border-brand-600 transition" href="./๐ ูุซููุฉ ุงููุธุงู ุงูุชูููุฐู ูุงูุชููู ุงูุดุงูู ูููุตุฉ (1).docx" download><span class="truncate">๐ ูุซููุฉ ุงููุธุงู ุงูุชูููุฐู ูุงูุชููู ุงูุดุงูู ูููุตุฉ (1).docx</span><span class="text-xs rounded-full bg-emerald-50 text-emerald-700 px-3 py-1">ุชูุฒูู</span></a>
        <a class="flex items-center justify-between rounded-xl border border-slate-200 bg-white px-4 py-3 hover:border-brand-600 transition" href="./ุงูููู ุงููุงูููู ูุงูุงุณุชุฑุงุชูุฌู ุงูุดุงูู ูุชูุนูู ุงูุดุฑุงูุงุช ูู ููุตุฉ ุญุตูู.docx" download><span class="truncate">ุงูููู ุงููุงูููู ูุงูุงุณุชุฑุงุชูุฌู ุงูุดุงูู ูุชูุนูู ุงูุดุฑุงูุงุช ูู ููุตุฉ ุญุตูู.docx</span><span class="text-xs rounded-full bg-emerald-50 text-emerald-700 px-3 py-1">ุชูุฒูู</span></a>
        <a class="flex items-center justify-between rounded-xl border border-slate-200 bg-white px-4 py-3 hover:border-brand-600 transition" href="./ุงูููู ุงููุงูููู ูุงูุงุณุชุฑุงุชูุฌู ุงูุดุงูู ูุชูุนูู ุงูุดุฑุงูุงุช ูู ููุตุฉ ุญุตูู (1).docx" download><span class="truncate">ุงูููู ุงููุงูููู ูุงูุงุณุชุฑุงุชูุฌู ุงูุดุงูู ูุชูุนูู ุงูุดุฑุงูุงุช ูู ููุตุฉ ุญุตูู (1).docx</span><span class="text-xs rounded-full bg-emerald-50 text-emerald-700 px-3 py-1">ุชูุฒูู</span></a>
        <a class="flex items-center justify-between rounded-xl border border-slate-200 bg-white px-4 py-3 hover:border-brand-600 transition" href="./ุดุฑุงูุฉ ุนูููุฉ ุงุณุชุฑุงุชูุฌูุฉ ุจูู ุงูุฌุงูุนุงุช ูููุตุฉ ุญุตูู.docx" download><span class="truncate">ุดุฑุงูุฉ ุนูููุฉ ุงุณุชุฑุงุชูุฌูุฉ ุจูู ุงูุฌุงูุนุงุช ูููุตุฉ ุญุตูู.docx</span><span class="text-xs rounded-full bg-emerald-50 text-emerald-700 px-3 py-1">ุชูุฒูู</span></a>
        <a class="flex items-center justify-between rounded-xl border border-slate-200 bg-white px-4 py-3 hover:border-brand-600 transition" href="./ุดุฑุงูุฉ ุงุณุชุฑุงุชูุฌูุฉ ูุทููุฉ ูุน ููููุงุช ุชุทููุฑ ุงูููุงุทู .docx" download><span class="truncate">ุดุฑุงูุฉ ุงุณุชุฑุงุชูุฌูุฉ ูุทููุฉ ูุน ููููุงุช ุชุทููุฑ ุงูููุงุทู .docx</span><span class="text-xs rounded-full bg-emerald-50 text-emerald-700 px-3 py-1">ุชูุฒูู</span></a>
        <a class="flex items-center justify-between rounded-xl border border-slate-200 bg-white px-4 py-3 hover:border-brand-600 transition" href="./ูุฑุตุฉ ููููุฉ ุงุณุชุฑุงุชูุฌูุฉ.pdf" download><span class="truncate">ูุฑุตุฉ ููููุฉ ุงุณุชุฑุงุชูุฌูุฉ.pdf</span><span class="text-xs rounded-full bg-emerald-50 text-emerald-700 px-3 py-1">ุชูุฒูู</span></a>
      </div>
      <hr class="my-6 border-steel-200"/>
      <h3 class="font-extrabold text-lg">ุฅุนุฏุงุฏุงุช ุงูุญุณุงุจุงุช (JSON)</h3>
      <div class="mt-3"><button id="reloadCfg" class="btn">ุฅุนุงุฏุฉ ุงูุชุญููู</button></div>
      <ul id="cfgList" class="mt-3 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 text-sm"></ul>
    </div>
  </div>
</section>

<!-- MAP -->
<section id="view-map" class="section hidden">
  <div class="mx-auto max-w-6xl px-4">
    <div class="card p-5 lg:p-6 shadow-md">
      <div class="flex items-center justify-between">
        <div>
          <h2 class="text-2xl font-black">ุงูุฎุฑูุทุฉ ูุงููุคุดุฑุงุช ุงูููุงุทููุฉ</h2>
          <p class="mt-1 text-steel-600 text-sm">ุงุฑูุน ููู <code>regions.geojson</code> ุจุฌูุงุฑ index.html ูุณูููุฑุฃ ุชููุงุฆููุง.</p>
        </div>
        <button id="reloadGeo" class="btn">ุฅุนุงุฏุฉ ุชุญููู</button>
      </div>
      <div class="mt-4 grid lg:grid-cols-3 gap-4">
        <div class="lg:col-span-2">
          <div id="mapStage" class="rounded-2xl border border-steel-200 bg-gradient-to-tr from-emerald-50 to-steel-50 p-6 h-[360px] overflow-auto">
            <div id="geoStatus" class="text-sm text-steel-600">ูู ูุชู ุชุญููู GeoJSON ุจุนุฏ.</div>
            <ul id="geoList" class="mt-3 grid grid-cols-2 gap-2 text-sm"></ul>
          </div>
        </div>
        <div>
          <div class="kpi"><div class="kpi-label">ููุทูุฉ ูุฎุชุงุฑุฉ</div><div id="selRegion" class="kpi-value">โ</div></div>
          <div class="grid grid-cols-3 gap-2 mt-2">
            <div class="kpi"><div class="kpi-label">ูุธุงุฆู</div><div id="kpiJobs" class="kpi-value">โ</div></div>
            <div class="kpi"><div class="kpi-label">ููุญ</div><div id="kpiGrants" class="kpi-value">โ</div></div>
            <div class="kpi"><div class="kpi-label">ูุชุทูุนูู</div><div id="kpiVols" class="kpi-value">โ</div></div>
          </div>
          <p class="mt-3 text-xs text-steel-500">ุณูุชู ุงุณุชุจุฏุงู ูุฐู ุงููุงุฆูุฉ ุจุฎุฑูุทุฉ ุชูุงุนููุฉ ูุงููุฉ ุญุงู ุฅุชุงุญุฉ ููู ุฑุณูู.</p>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Console -->
<div class="h-20"></div>
<div id="consoleBar" class="fixed bottom-0 inset-x-0 z-50">
  <div class="mx-auto max-w-6xl px-4">
    <div class="glass border border-steel-200 rounded-t-2xl px-3 py-2 shadow">
      <div class="flex flex-wrap items-center gap-2">
        <span class="text-sm font-bold text-steel-700">ุงููุถุน ุงูุชุฌุฑูุจู</span>
        <button id="seedBtn" class="btn">ููุก ุจูุงูุงุช</button>
        <button id="clearBtn" class="btn">ุชูุฑูุบ</button>
        <div class="grow"></div>
        <label class="text-sm">ุงูุฏูุฑ:
          <select id="roleSelect" class="rounded-xl border border-steel-200 px-2 py-1 text-sm">
            <option>ุงููุดุฑู ุงูุนุงู</option>
            <option>ูุฏูุฑ ุงููุธุงู</option>
            <option>ูุดุบูู</option>
            <option>ูุฑุงูุจ</option>
            <option>ุฒุงุฆุฑ</option>
            <option>ููุซู ุฌูุฉ ุดุฑููุฉ</option>
          </select>
        </label>
        <label class="text-sm">ุงููุณุงุฑ: <span id="routeLabel" class="font-extrabold text-brand-600">#login</span></label>
      </div>
    </div>
  </div>
</div>

<!-- EMBEDDED BUNDLE: ุชุจููุจุงุช ูุชุฏูููุงุช ูู ุญุณุงุจ -->
<script>
const EMBED_BUNDLE={
 "ุงูุฃูุฑุงุฏ":{tabs:["ุงููุจุงุฏุฑุงุช","ุงููุฑุต","ุงูุชุทูุน","ุงูุชุฏุฑูุจ","ุงูุชูุธูู","ุงููุนุงููุงุช","ุงููุญูุธุฉ","ุงูุชูุงุฑูุฑ"],
  workflow:[{step:"ุงูุชูููู",role:"ูุดุบูู",policy:"ูุฑุงุฌุนุฉ ุจูุงูุงุช ุงููุจุงุฏุฑุฉ"},
            {step:"ููุงุกูุฉ ุงูุฑุคูุฉ",role:"ูุฏูุฑ ุงููุธุงู",policy:"ุชุตููู ุชููุงุฆู + ุงุนุชูุงุฏ ุจุดุฑู"},
            {step:"ุชุนุฒูุฒ ุนููู",role:"ููุซู ุฌูุฉ ุดุฑููุฉ",policy:"ุฌุงูุนุฉ/ูุฑูุฒ ุจุญุซู"},
            {step:"ุชูููู/ุฑุนุงูุฉ",role:"ุงููุดุฑู ุงูุนุงู",policy:"ุณูุฑ ููุงููุงุช ูุชุนุฏุฏ"},
            {step:"ุชูููุฐ",role:"ูุดุบูู",policy:"ููุงู ูููุฒุงููุฉ"},
            {step:"ุฃุซุฑ ูุชูุงุฑูุฑ",role:"ูุฑุงูุจ",policy:"ูุคุดุฑุงุช ููุดุฑ ูุฎุชุตุฑ"}]},
 "ุงููุทุงุน ุงูุฎุงุต":{tabs:["ุงููุดุงุฑูุน","ุงูุฑุนุงูุงุช","ุงููุธุงุฆู","ุงูุชุฏุฑูุจ ุงูุชุนุงููู","ุงูุงุณุชุดุงุฑุงุช","ุงููุฑุงูู","ESG","ุชูุงุฑูุฑ CSRD","ุงููุญูุธุฉ","ุงูุชูุงุฑูุฑ"],
  workflow:[{step:"ุทูุจ ุฑุนุงูุฉ/CSR",role:"ูุดุบูู",policy:"ูุทุงุจูุฉ ูุนุงููุฑ CSR"},
            {step:"ูุฑุงุฌุนุฉ ูุงููููุฉ/ูุงููุฉ",role:"ูุฏูุฑ ุงููุธุงู",policy:"ููุงุฐุฌ ุนููุฏ ุฌุงูุฒุฉ"},
            {step:"ุชูููุน ุฑููู",role:"ุงููุดุฑู ุงูุนุงู",policy:"ุงุนุชูุงุฏ ููุงุฆู"},
            {step:"ูุชุงุจุนุฉ ุงูุฃุฏุงุก",role:"ูุฑุงูุจ",policy:"ESG/CSRD + KPIs"}]},
 "ุงููุทุงุน ุบูุฑ ุงูุฑุจุญู":{tabs:["ุงููุจุงุฏุฑุงุช","ุทูุจุงุช ุงูุชูููู","ุงูุฑุนุงูุงุช","ุงูุชุทูุน","ุงูุชุฏุฑูุจ","ุงููุนุงููุงุช","ุงูุชุตุงุฑูุญ","ุงููุญูุธุฉ","ุงูุชูุงุฑูุฑ"],
  workflow:[{step:"ุฅุฏุฑุงุฌ ูุดุฑูุน",role:"ูุดุบูู",policy:"ููู ุฃุซุฑ ูุฎุชุตุฑ"},
            {step:"ูุทุงุจูุฉ ูุงูุญูู",role:"ูุฏูุฑ ุงููุธุงู",policy:"ุชูุถููุงุช ุงูุชูููู"},
            {step:"ุฌูุน ุงูุชุจุฑุนุงุช",role:"ุงููุดุฑู ุงูุนุงู",policy:"ูุญูุธุฉ ูุชูุซูู"},
            {step:"ุงูุชูููุฐ ูุงูุฃุซุฑ",role:"ูุดุบูู",policy:"ุชูุงุฑูุฑ ุดูุงูุฉ"}]},
 "ุงูุฌุงูุนุงุช":{tabs:["ุงูุฃุจุญุงุซ","ุงูุงุณุชุดุงุฑุงุช","ุงูุชุฏุฑูุจ ุงูุชุนุงููู","ุงูุญููู","ุงููุฑุงูู","ุงููุนุงููุงุช","ุงููุคุดุฑุงุช","ุงููุญูุธุฉ","ุงูุชูุงุฑูุฑ"],
  workflow:[{step:"ุงุณุชูุงู ุทูุจ ุชุนุฒูุฒ",role:"ููุซู ุฌูุฉ ุดุฑููุฉ",policy:"ุชูููู ูุฎุชุตุฑ"},
            {step:"ูุฑุงุฌุนุฉ ูุฌูุฉ",role:"ูุฏูุฑ ุงููุธุงู",policy:"ูุฑุงุฑ ุงุนุชูุงุฏ/ุชุญุณูู"},
            {step:"ุชูุฑูุฑ ุนููู",role:"ูุฑุงูุจ",policy:"ูุดุฑ ุงูููุฎุต"}]},
 "ุงูุฌูุงุช ุงูุญููููุฉ":{tabs:["ุงูุชุญุฏูุงุช","ุงูุญููู ุงููุณุชููุฉ","ุงููุดุงุฑูุน","ุงูุชุตุงุฑูุญ","ุงููุนุงููุงุช","ุงููุคุดุฑุงุช","ุงูุชููููุงุช","ุงููุญูุธุฉ","ุงูุชูุงุฑูุฑ"],
  workflow:[{step:"ุชุณุฌูู ุชุญุฏูู",role:"ูุดุบูู",policy:"ูุทุงู/ูุคุดุฑุงุช"},
            {step:"ูุทุงุฑุญุฉ ุญููู",role:"ููุซู ุฌูุฉ ุดุฑููุฉ",policy:"ููุตุฉ ุญููู"},
            {step:"ุงุนุชูุงุฏ ูุชูููุฐ",role:"ูุฏูุฑ ุงููุธุงู",policy:"ุชุตุฑูุญ ููุชุงุจุนุฉ"}]},
 "ุงูุฌูุงุช ุงูุชูููููุฉ":{tabs:["ุทูุจุงุช ุงูุชูููู","ุงูุฑุนุงูุงุช","ุงููุญูุธุฉ","ุชูุงุฑูุฑ ุงูุฃุซุฑ","ุงูุชูุงุฑูุฑ ุงููุงููุฉ","ุงูุชูุงุฑูุฑ"],
  workflow:[{step:"ุงุณุชูุงู ุงูุทูุจ",role:"ูุดุบูู",policy:"ุชุตููุฉ ูุจุฏุฆูุฉ"},
            {step:"ูุฑุงุฌุนุฉ ูุฌูุฉ",role:"ูุฏูุฑ ุงููุธุงู",policy:"ุณูุงุณุงุช ุงูุชูููู"},
            {step:"ุงุนุชูุงุฏ ูุชุญููู",role:"ุงููุดุฑู ุงูุนุงู",policy:"ุฏูุนุงุช ููุญูุธุฉ"},
            {step:"ุชูุฑูุฑ ุฃุซุฑ",role:"ูุฑุงูุจ",policy:"ุฅุบูุงู"}]},
 "ุฅูุงุฑุฉ ุงูููุทูุฉ":{tabs:["ุงูุชุตุงุฑูุญ ุงูุฃูููุฉ","ููุญุฉ ุงูุชูููุฉ","ุฑุนุงูุงุช ุงูุฃููุฑ","ุงููุนุงููุงุช","ุงููุคุดุฑุงุช","ุงููุญุงูุธุงุช","ุงููุญูุธุฉ","ุงูุชูุงุฑูุฑ"],
  workflow:[{step:"ุทูุจ ุชุตุฑูุญ",role:"ูุดุบูู",policy:"ุชุญูู ุฃููู"},
            {step:"ุงุนุชูุงุฏ",role:"ูุฏูุฑ ุงููุธุงู",policy:"ุงุดุชุฑุงุทุงุช ุชูุธูููุฉ"},
            {step:"ูุชุงุจุนุฉ",role:"ูุฑุงูุจ",policy:"ุชูุฑูุฑ ุฎุชุงูู"}]},
 "ููุฆุงุช ุงูุชุทููุฑ":{tabs:["ุจุฑุงูุฌ ุงููุฏู","ุงููุดุงุฑูุน","ุงููุนุงููุงุช","ุงูุชุตุงุฑูุญ","ุงููุคุดุฑุงุช","ุงููุญูุธุฉ","ุงูุดุฑุงูุงุช","ุงูุชูุงุฑูุฑ"],
  workflow:[{step:"ููุงุกูุฉ ุจุฑูุงูุฌ",role:"ูุฏูุฑ ุงููุธุงู",policy:"ุฃูุฏุงู ุงููุฏููุฉ"},
            {step:"ุชูููุฐ",role:"ูุดุบูู",policy:"ุงูุฅููุงู ูุงูุฌุฏูู"},
            {step:"ุฃุซุฑ ุญุถุฑู",role:"ูุฑุงูุจ",policy:"KPIs ููุงููุฉ"}]},
 "ุฅุฏุงุฑุฉ ุงูููุตุฉ":{tabs:["ุงูุญุณุงุจุงุช ูุงูุญูููุฉ","ุงูุตูุงุญูุงุช","ุงูุชูุงูู ูุงูุจูุงูุงุช","ุงูุฅุดุนุงุฑุงุช","ุงูุฏุนู","ุงูุชูุงุฑูุฑ","ุฅุฏุงุฑุฉ ุงูุตูุงุญูุงุช ูุงูุฃุฏูุงุฑ"],
  workflow:[{step:"ุฅูุดุงุก ุญุณุงุจ",role:"ุงููุดุฑู ุงูุนุงู",policy:"ุชููุฆุฉ ูุตูุงุญูุงุช"},
            {step:"ุฑุจุท ุชูุงููู",role:"ูุฏูุฑ ุงููุธุงู",policy:"API/Webhooks"},
            {step:"ุญูููุฉ",role:"ูุฑุงูุจ",policy:"ุชุฏููู ูุฃุซุฑ"}]}
};
</script>

<!-- APP SCRIPT: ุงูุชูุฌููุ ุงูุฌูุณุฉุ ุงูุฃุฏูุงุฑุ ุงูููุญุงุชุ ุงูุฐูุงุก ุงููุญููุ ุงููุซุงุฆูุ ุงูุฎุฑูุทุฉ -->
<script>
const $=(s,c=document)=>c.querySelector(s); const $$=(s,c=document)=>Array.from(c.querySelectorAll(s));
const views={login:$('#view-login'),home:$('#view-home'),dashboard:$('#view-dashboard'),docs:$('#view-docs'),map:$('#view-map')};
function setRoute(r){Object.entries(views).forEach(([k,el])=>el.classList.toggle('hidden',k!==r)); $$('[data-nav]').forEach(a=>a.setAttribute('aria-current',a.getAttribute('data-nav')===r?'page':null)); $('#routeLabel').textContent='#'+r; if(r==='map')tryLoadGeo(); if(r==='docs')loadConfigs();}
addEventListener('hashchange',()=>{const r=(location.hash||'#login').replace('#',''); setRoute(r in views?r:'login');});
setRoute((location.hash||'#login').replace('#','') in views?(location.hash||'#login').replace('#',''):'login');

const KEY='hp_portal_final_gov';
let state=(()=>{try{return JSON.parse(localStorage.getItem(KEY))}catch(_){} })()||{account:null,rows:{},roles:{map:{}},currentRole:'ุงููุดุฑู ุงูุนุงู',session:null};
function save(){localStorage.setItem(KEY,JSON.stringify(state));}
const ROLES=['ุงููุดุฑู ุงูุนุงู','ูุฏูุฑ ุงููุธุงู','ูุดุบูู','ูุฑุงูุจ','ุฒุงุฆุฑ','ููุซู ุฌูุฉ ุดุฑููุฉ'];
const PERMS=['ุฅุฏุงุฑุฉ ุงูุญุณุงุจุงุช','ุงุนุชูุงุฏ ุงููุดุงุฑูุน','ุฅุฏุงุฑุฉ ุงูุฑุนุงูุงุช','ุชุนุฏูู ุงูุจูุงูุงุช','ุชูููุฏ ุงูุชูุงุฑูุฑ','ูุตูู API'];
const DEFAULT_ROLE_MAP={
 'ุงููุดุฑู ุงูุนุงู':['ุฅุฏุงุฑุฉ ุงูุญุณุงุจุงุช','ุงุนุชูุงุฏ ุงููุดุงุฑูุน','ุฅุฏุงุฑุฉ ุงูุฑุนุงูุงุช','ุชุนุฏูู ุงูุจูุงูุงุช','ุชูููุฏ ุงูุชูุงุฑูุฑ','ูุตูู API'],
 'ูุฏูุฑ ุงููุธุงู':['ุฅุฏุงุฑุฉ ุงูุญุณุงุจุงุช','ุงุนุชูุงุฏ ุงููุดุงุฑูุน','ุฅุฏุงุฑุฉ ุงูุฑุนุงูุงุช','ุชุนุฏูู ุงูุจูุงูุงุช','ุชูููุฏ ุงูุชูุงุฑูุฑ','ูุตูู API'],
 'ูุดุบูู':['ุงุนุชูุงุฏ ุงููุดุงุฑูุน','ุฅุฏุงุฑุฉ ุงูุฑุนุงูุงุช','ุชุนุฏูู ุงูุจูุงูุงุช','ุชูููุฏ ุงูุชูุงุฑูุฑ'],
 'ูุฑุงูุจ':['ุชูููุฏ ุงูุชูุงุฑูุฑ'],
 'ุฒุงุฆุฑ':[],
 'ููุซู ุฌูุฉ ุดุฑููุฉ':['ุงุนุชูุงุฏ ุงููุดุงุฑูุน','ุชูููุฏ ุงูุชูุงุฑูุฑ']
};
ROLES.forEach(r=>{state.roles.map[r]=state.roles.map[r]||{}; PERMS.forEach(p=>state.roles.map[r][p]=state.roles.map[r][p]??DEFAULT_ROLE_MAP[r].includes(p));});
$('#roleSelect').value=state.currentRole; function can(p){return !!(state.roles.map?.[state.currentRole]?.[p]);}

const EMBED_ACCOUNTS=Object.keys(EMBED_BUNDLE);
const EMBED_TABS=Object.fromEntries(Object.entries(EMBED_BUNDLE).map(([k,v])=>[k,v.tabs||[]]));

const fAccount=$('#fAccount'); fAccount.innerHTML=EMBED_ACCOUNTS.map(a=>`<option>${a}</option>`).join('');
$('#loginForm').addEventListener('submit',e=>{
 e.preventDefault();
 const user=$('#fUser').value.trim(), pass=$('#fPass').value.trim(), acc=$('#fAccount').value;
 if(!user||!pass){$('#loginMsg').classList.remove('hidden');return;}
 state.session={user,acc,role:state.currentRole,ts:Date.now(),remember:$('#fRemember').checked}; state.account=acc; save();
 $('#logoutBtn').classList.remove('hidden'); location.hash='#dashboard';
});
$('#logoutBtn').addEventListener('click',()=>{state.session=null;state.account=null;save();$('#logoutBtn').classList.add('hidden');location.hash='#login';});

function buildAccountGrid(list){
 const grid=$('#accountGrid');
 grid.innerHTML=list.map(n=>`
  <a href="#dashboard" class="text-start rounded-2xl border border-steel-200 bg-white p-4 hover:border-brand-600 hover:shadow-md transition" data-name="${n}">
    <div class="flex items-center justify-between gap-2">
      <h3 class="font-extrabold">ุญุณุงุจ ${n}</h3>
      <span class="badge">ูุงูู ุงูุฎุฏูุงุช</span>
    </div>
    <p class="mt-2 text-sm text-steel-700">ููุญุงุช ${n} ูุตูุงุญูุงุช ููู ุงูุฏูุฑ.</p>
  </a>`).join('');
 $$('#accountGrid a').forEach(b=>b.addEventListener('click',()=>openDashboard(b.dataset.name)));
}
buildAccountGrid(EMBED_ACCOUNTS);

function openDashboard(name){
 if(!state.session){location.hash='#login';return;}
 state.account=name||state.session.acc; save();
 $('#dashTitle').textContent='ููุญุฉ ุญุณุงุจ โ '+state.account;
 buildTabs(state.account); refreshKPIs(); setRoute('dashboard');
}

function getSchema(tab){
 switch(tab){
  case'ุงููุจุงุฏุฑุงุช':case'ุงููุดุงุฑูุน':return[{name:'title',label:'ุงูุนููุงู'},{name:'owner',label:'ุงูุฌูุฉ'},{name:'budget',label:'ุงูููุฒุงููุฉ (ุฑ.ุณ)'},{name:'region',label:'ุงูููุทูุฉ'},{name:'status',label:'ุงูุญุงูุฉ'}];
  case'ุงููุฑุต':case'ุทูุจุงุช ุงูุชูููู':return[{name:'title',label:'ุงูุนููุงู'},{name:'cat',label:'ุงูุชุตููู'},{name:'amount',label:'ุงููุจูุบ (ุฑ.ุณ)'},{name:'state',label:'ุงูุญุงูุฉ'}];
  case'ุงูุฑุนุงูุงุช':return[{name:'title',label:'ุงูุนููุงู'},{name:'cat',label:'ุงูุชุตููู'},{name:'amount',label:'ุงููุจูุบ (ุฑ.ุณ)'},{name:'state',label:'ุงูุญุงูุฉ'}];
  case'ุงูุชุตุงุฑูุญ':case'ุงูุชุตุงุฑูุญ ุงูุฃูููุฉ':return[{name:'org',label:'ุงูุฌูุฉ'},{name:'type',label:'ููุน ุงููุดุงุท'},{name:'date',label:'ุงูุชุงุฑูุฎ'},{name:'status',label:'ุงูุญุงูุฉ'}];
  case'ุงููุนุงููุงุช':return[{name:'name',label:'ุงุณู ุงููุนุงููุฉ'},{name:'venue',label:'ุงูููุงู'},{name:'date',label:'ุงูุชุงุฑูุฎ'},{name:'status',label:'ุงูุญุงูุฉ'}];
  case'ุงูุชุฏุฑูุจ':case'ุงูุชุฏุฑูุจ ุงูุชุนุงููู':return[{name:'program',label:'ุงูุจุฑูุงูุฌ'},{name:'hours',label:'ุงูุณุงุนุงุช'},{name:'type',label:'ุงูููุน'},{name:'status',label:'ุงูุญุงูุฉ'}];
  case'ุงูุชุทูุน':return[{name:'title',label:'ุนููุงู ุงููุฑุตุฉ'},{name:'org',label:'ุงูุฌูุฉ ุงูููุธูุฉ'},{name:'hours',label:'ุงูุณุงุนุงุช'},{name:'date',label:'ุงูุชุงุฑูุฎ'}];
  case'ุงูุงุณุชุดุงุฑุงุช':return[{name:'topic',label:'ุงูููุถูุน'},{name:'benef',label:'ุงูุฌูุฉ ุงููุณุชููุฏุฉ'},{name:'date',label:'ุงูุชุงุฑูุฎ'},{name:'result',label:'ุงููุชูุฌุฉ'}];
  case'ุงููุคุดุฑุงุช':case'ุชูุงุฑูุฑ ุงูุฃุซุฑ':return[{name:'kpi',label:'ุงููุคุดุฑ'},{name:'project',label:'ุงููุดุฑูุน/ุงููุจุงุฏุฑุฉ'},{name:'value',label:'ุงููููุฉ'},{name:'unit',label:'ุงููุญุฏุฉ'}];
  case'ุงููุญูุธุฉ':return[{name:'benef',label:'ุงูุฌูุฉ ุงููุณุชููุฏุฉ'},{name:'amount',label:'ุงููุจูุบ (ุฑ.ุณ)'},{name:'kind',label:'ููุน ุงูุนูููุฉ'},{name:'note',label:'ูุตู'}];
  case'ESG':return[{name:'pillar',label:'ุงููุญูุฑ'},{name:'metric',label:'ุงููุคุดุฑ'},{name:'value',label:'ุงููููุฉ'},{name:'unit',label:'ุงููุญุฏุฉ'}];
  case'ุชูุงุฑูุฑ CSRD':return[{name:'topic',label:'ุงูููุถูุน'},{name:'req',label:'ุงููุทูุจ'},{name:'status',label:'ุงูุญุงูุฉ'},{name:'note',label:'ููุงุญุธุฉ'}];
  case'ุงูุชูุงูู ูุงูุจูุงูุงุช':return[{name:'endpoint',label:'ููุทุฉ ุงูุชูุงูู'},{name:'method',label:'ุงูุทุฑููุฉ'},{name:'scope',label:'ุงููุทุงู'},{name:'status',label:'ุงูุญุงูุฉ'}];
  case'ุงูุชููููุงุช':return[{name:'subject',label:'ุงูููุถูุน'},{name:'score',label:'ุงูุชูููู'},{name:'date',label:'ุงูุชุงุฑูุฎ'},{name:'note',label:'ููุงุญุธุฉ'}];
  case'ุงูุดุฑุงูุงุช':return[{name:'partner',label:'ุงูุดุฑูู'},{name:'type',label:'ุงูููุน'},{name:'date',label:'ุงูุชุงุฑูุฎ'},{name:'status',label:'ุงูุญุงูุฉ'}];
  case'ุงูุญุณุงุจุงุช ูุงูุญูููุฉ':return[{name:'account',label:'ุงูุญุณุงุจ'},{name:'owner',label:'ุงููุงูู'},{name:'status',label:'ุงูุญุงูุฉ'},{name:'note',label:'ููุงุญุธุฉ'}];
  default:return[{name:'title',label:'ุงูุนููุงู'},{name:'note',label:'ูุตู'},{name:'date',label:'ุงูุชุงุฑูุฎ'},{name:'status',label:'ุงูุญุงูุฉ'}];
 }
}
function panelHeaderActions(tab,key){
 const addBtn=`<button class="btn btn-primary" data-add="${key}" ${!can('ุชุนุฏูู ุงูุจูุงูุงุช')?'disabled':''}>+ ุฅุถุงูุฉ</button>`;
 const exportBtn=`<button class="btn" data-export="${key}" ${!can('ุชูููุฏ ุงูุชูุงุฑูุฑ')?'disabled':''}>ุชุตุฏูุฑ CSV</button>`;
 const wfBtn=(tab==='ุทูุจุงุช ุงูุชูููู'||tab==='ุงูุฑุนุงูุงุช')?`<button class="btn btn-gov" data-wf="${key}" ${!can('ุฅุฏุงุฑุฉ ุงูุฑุนุงูุงุช')?'disabled':''}>ุณูุฑ ุงูููุงููุงุช</button>`:'';
 return `${wfBtn}${addBtn}${exportBtn}`;
}
function renderSmartChip(row){
 const tags=(row._vision||[]).map(v=>v.code).join('ยท')||'โ';
 const top=(row._matches||[])[0]; const partner=top?`${top.name} (${(top.score*100).toFixed(0)}%)`:'โ';
 const risk=row._risk?row._risk.level:'โ';
 return `<span class="smart-chip">๐ฏ ${tags} โข ๐ค ${partner} โข โ๏ธ ${risk}</span>`;
}
function rolesPanel(){
 const RO=ROLES; const th=['ุตูุงุญูุฉ/ุฏูุฑ'].concat(RO).map(h=>`<th class="px-3 py-2 text-right">${h}</th>`).join('');
 const rows=PERMS.map(p=>{
  const tds=RO.map(r=>{
   const checked=state.roles.map[r]?.[p]?'checked':'';
   return `<td class="px-3 py-2"><input type="checkbox" data-role="${r}" data-perm="${p}" ${checked}></td>`;
  }).join('');
  return `<tr><td class="px-3 py-2 font-semibold">${p}</td>${tds}</tr>`;
 }).join('');
 return `
  <div class="card p-4 lg:p-5 shadow-md">
    <div class="flex items-center justify-between gap-2">
      <h3 class="font-extrabold">ุฅุฏุงุฑุฉ ุงูุตูุงุญูุงุช ูุงูุฃุฏูุงุฑ</h3>
      <div class="flex items-center gap-2">
        <button id="rolesReset" class="btn">ุฅุนุงุฏุฉ ุงูุถุจุท</button>
        <button id="rolesSave" class="btn btn-primary">ุญูุธ</button>
      </div>
    </div>
    <div class="mt-3 overflow-x-auto">
      <table class="w-full text-sm border border-steel-200 rounded-xl">
        <thead class="bg-steel-50"><tr>${th}</tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
    <p class="mt-3 text-xs text-steel-500">ุชูุญูุธ ุงูุตูุงุญูุงุช ูุญูููุง โ ูุชูุนูุณ ูุจุงุดุฑุฉ ุนูู ุงูุฃุฒุฑุงุฑ.</p>
  </div>`;
}
function panelTemplate(acc,tab){
 if(tab==='ุฅุฏุงุฑุฉ ุงูุตูุงุญูุงุช ูุงูุฃุฏูุงุฑ') return rolesPanel();
 const key=acc+'::'+tab; const schema=getSchema(tab);
 const headers=schema.map(s=>`<th class='text-right py-2'>${s.label}</th>`).join('')+`<th class='text-right py-2'>ุฅุฌุฑุงุกุงุช</th>`;
 const hint=(tab==='ุงููุจุงุฏุฑุงุช'||tab==='ุงููุดุงุฑูุน')?`<div class='text-xs text-steel-500'>ุนูุฏ ุฅุถุงูุฉ ุณุฌู ุณูุธูุฑ ุดุฑูุท ุฐูุงุก ุชููุงุฆููุง (ุฑุคูุฉ/ุดุฑูุงุก/ูุฎุงุทุฑ).</div>`:'';
 return `
  <div class="card p-4 lg:p-5 shadow-md">
    <div class="flex items-center justify-between gap-2">
      <div class="flex items-center gap-2"><h3 class="font-extrabold">${tab}</h3><span class="text-xs text-steel-500">${schema.length} ุญููู</span></div>
      <div class="flex items-center gap-2">${panelHeaderActions(tab,key)}</div>
    </div>
    ${hint}
    <div class="mt-3 overflow-x-auto">
      <table class="w-full text-sm"><thead><tr class="text-steel-600">${headers}</tr></thead><tbody id="tbl::${key}" class="align-top"></tbody></table>
    </div>
  </div>`;
}
function buildTabs(acc){
 const tabs=(EMBED_TABS[acc]||[]);
 $('#tabs').innerHTML=tabs.map((t,i)=>`<button class="tab-btn btn ${i===0?'btn-primary':''}" aria-selected="${i===0?'true':'false'}" data-tab="${t}">${t}</button>`).join('');
 $('#panels').innerHTML=tabs.map((t,i)=>`<div class="panel ${i===0?'':'hidden'}" data-panel="${t}">${panelTemplate(acc,t)}</div>`).join('');
 $$('#tabs .tab-btn').forEach(b=>b.addEventListener('click',()=>switchTab(b.dataset.tab)));
 bindPanelHandlers();
}
function switchTab(tab){
 $$('#tabs .tab-btn').forEach(b=>{b.setAttribute('aria-selected',b.dataset.tab===tab); b.classList.toggle('btn-primary',b.dataset.tab===tab);});
 $$('#panels .panel').forEach(p=>p.classList.toggle('hidden',p.dataset.panel!==tab));
}
function bindPanelHandlers(){
 $$('[data-add]').forEach(btn=>btn.addEventListener('click',()=>{
  if(!can('ุชุนุฏูู ุงูุจูุงูุงุช')) return alert('ุตูุงุญูุฉ ุบูุฑ ูุงููุฉ.');
  const key=btn.dataset.add; const tab=key.split('::')[1]; const schema=getSchema(tab);
  const row={}; schema.forEach(s=>row[s.name]=prompt('ุฃุฏุฎู '+s.label)||'');
  (state.rows[key]=state.rows[key]||[]).push(row); save(); renderTable(key,true); refreshKPIs();
 }));
 $$('[data-export]').forEach(btn=>btn.addEventListener('click',()=>{
  if(!can('ุชูููุฏ ุงูุชูุงุฑูุฑ')) return alert('ุตูุงุญูุฉ ุบูุฑ ูุงููุฉ.');
  const key=btn.dataset.export; const list=state.rows[key]||[]; if(!list.length) return alert('ูุง ุชูุฌุฏ ุจูุงูุงุช');
  const headers=Object.keys(list[0]).filter(k=>!k.startsWith('_')); const esc=v=>(''+(v??'')).replaceAll('"','""');
  const csv=[headers.map(h=>`"${esc(h)}"`).join(',')].concat(list.map(r=>headers.map(h=>`"${esc(r[h])}"`).join(','))).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=key.replaceAll('::','_')+'.csv'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),500);
 }));
 if($('#rolesSave')){
  $('#rolesSave').addEventListener('click',()=>{save();alert('ุชู ุญูุธ ุงูุตูุงุญูุงุช');});
  $('#rolesReset').addEventListener('click',()=>{state.roles={map:{}}; ROLES.forEach(r=>{state.roles.map[r]={}; PERMS.forEach(p=>state.roles.map[r][p]=DEFAULT_ROLE_MAP[r].includes(p));}); save(); alert('ุฅุนุงุฏุฉ ุงูุถุจุท ุชูุช'); buildTabs(state.account);});
  $$('input[type="checkbox"][data-role]').forEach(ch=>ch.addEventListener('change',()=>{const r=ch.dataset.role,p=ch.dataset.perm; state.roles.map[r]=state.roles.map[r]||{}; state.roles.map[r][p]=ch.checked; save();}));
 }
 Object.keys(state.rows).forEach(k=>renderTable(k,false));
}
function renderTable(key,enrich){
 const el=document.getElementById('tbl::'+key); if(!el) return;
 const list=state.rows[key]||[]; const tab=key.split('::')[1]; const schema=getSchema(tab);
 if(enrich&&(tab==='ุงููุจุงุฏุฑุงุช'||tab==='ุงููุดุงุฑูุน')){const row=list[list.length-1]; if(row) smartEnrich(row);}
 el.innerHTML=list.length?list.map((r,idx)=>{
  const tds=schema.map(s=>`<td class='py-2'>${r[s.name]||''}</td>`).join('');
  const chip=(tab==='ุงููุจุงุฏุฑุงุช'||tab==='ุงููุดุงุฑูุน')?`<div class='mt-1'>${renderSmartChip(r)}</div>`:'';
  const canEdit=can('ุชุนุฏูู ุงูุจูุงูุงุช');
  return `<tr><td colspan="100%"><div class="grid md:grid-cols-12 gap-2 items-start">
   <div class="md:col-span-9"><table class="w-full"><tr>${tds}<td class="py-2 flex items-center gap-3">
     <button class="action edit" data-edit="${key}::${idx}" ${!canEdit?'disabled':''}>ุชุนุฏูู</button>
     <button class="action del" data-del="${key}::${idx}" ${!canEdit?'disabled':''}>ุญุฐู</button>
   </td></tr></table>${chip}</div>
   <div class="md:col-span-3 hidden md:block"></div>
  </div></td></tr>`;
 }).join(''):`<tr><td class="py-4 text-center text-steel-500" colspan="${schema.length+1}">ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>`;
 $$(`[data-edit^="${key}::"]`).forEach(b=>b.onclick=()=>{ if(!can('ุชุนุฏูู ุงูุจูุงูุงุช')) return alert('ุตูุงุญูุฉ ุบูุฑ ูุงููุฉ.');
  const idx=+b.dataset.edit.split('::').pop(); const row=(state.rows[key]||[])[idx]; if(!row) return;
  const sc=getSchema(tab); sc.forEach(s=>{row[s.name]=prompt('ุชุนุฏูู '+s.label,row[s.name]||'')??row[s.name];});
  if(tab==='ุงููุจุงุฏุฑุงุช'||tab==='ุงููุดุงุฑูุน') smartEnrich(row); save(); renderTable(key,false); refreshKPIs();
 });
 $$(`[data-del^="${key}::"]`).forEach(b=>b.onclick=()=>{ if(!can('ุชุนุฏูู ุงูุจูุงูุงุช')) return alert('ุตูุงุญูุฉ ุบูุฑ ูุงููุฉ.');
  const idx=+b.dataset.del.split('::').pop(); if(confirm('ุชุฃููุฏ ุงูุญุฐูุ')){(state.rows[key]||[]).splice(idx,1); save(); renderTable(key,false); refreshKPIs();}
 });
}

function refreshKPIs(){
 const acc=state.account; if(!acc) return;
 let inits=0,ops=0,bal=0,impact=0;
 Object.entries(state.rows).forEach(([k,list])=>{
  if(k.startsWith(acc+'::')){
   if(k.includes('ุงููุจุงุฏุฑุงุช')||k.includes('ุงููุดุงุฑูุน')) inits+=list.length;
   if(!k.includes('ุงููุญูุธุฉ')) ops+=list.length;
   if(k.includes('ุงููุคุดุฑุงุช')||k.includes('ุชูุงุฑูุฑ ุงูุฃุซุฑ')) impact+=list.reduce((a,r)=>a+(+r.value||0),0);
  }
 });
 Object.entries(state.rows).forEach(([k,list])=>{if(k===acc+'::ุงููุญูุธุฉ') bal=list.reduce((a,r)=>a+(+r.amount||0),0);});
 $('#kpiInits').textContent=inits; $('#kpiOps').textContent=ops; $('#kpiBal').textContent=new Intl.NumberFormat('ar-SA').format(bal); $('#kpiImpact').textContent=impact;
}

/* ุงูุฐูุงุก ุงููุญูู (ุชุตููู ุฑุคูุฉ/ูุทุงุจูุฉ ุดุฑูุงุก/ูุฎุงุทุฑ ูุจุณุทุฉ) */
const VISION_TAGS=[
 {code:'QOL',kw:['ุฌูุฏุฉ ุงูุญูุงุฉ','ุซูุงูุฉ','ุฑูุงุถุฉ','ุชุฑููู','ุณูุงุญุฉ']},
 {code:'HEALTH',kw:['ุตุญุฉ','ูุณุชุดูู','ุนูุงุฌ','ุทุจู','ููุงูุฉ']},
 {code:'EDU',kw:['ุชุนููู','ูุฏุฑุณุฉ','ุชุฏุฑูุจ','ุฌุงูุนุฉ','ููุงุฑุงุช']},
 {code:'ECON',kw:['ูุธุงุฆู','ููุดุขุช','ุงุณุชุซูุงุฑ','ุฑูุงุฏุฉ','ุตูุงุนุฉ']},
 {code:'ENV',kw:['ุจูุฆุฉ','ุชุดุฌูุฑ','ุงูุจุนุงุซ','ูุธุงูุฉ','ููุงูุงุช','ููุงู']},
 {code:'GOV',kw:['ุญูููุฉ','ุชุตุงุฑูุญ','ุชูููู','ุฎุฏูุงุช','ุฑูููุฉ']}
];
function classifyVision(text){const t=(text||'').toLowerCase(); const score={}; VISION_TAGS.forEach(p=>{score[p.code]=p.kw.reduce((a,k)=>a+(t.includes(k.toLowerCase())?1:0),0)}); return Object.entries(score).map(([code,s])=>({code,score:s})).filter(x=>x.score>0).sort((a,b)=>b.score-a.score).slice(0,2);}
function matchPartners(project){
 const partners=[{name:'ูุฑูุฒ ุฃุฏุงุก',focus:['GOV','ECON'],regions:'ALL'},
                 {name:'NCDC',focus:['GOV','QOL'],regions:'ALL'},
                 {name:"Monsha'at",focus:['ECON'],regions:'ALL'},
                 {name:'ุฌุงูุนุฉ ุญุงุฆู',focus:['EDU','ENV'],regions:['ุญุงุฆู','ุงููุฏููุฉ']},
                 {name:'ุดุฑูุฉ ูุทููุฉ (CSR)',focus:['QOL','ENV','EDU'],regions:'ALL'}];
 const tags=classifyVision((project.title||'')+' '+(project.note||'')).map(t=>t.code);
 return partners.map(p=>{
  const f=p.focus.some(f=>tags.includes(f))?1:0;
  const r=(p.regions==='ALL'||(project.region&&(p.regions||[]).includes(project.region)))?1:0;
  const b=(project.budget?(project.budget>100000?1:0):0);
  const s=f*0.6+r*0.3+b*0.1; return Object.assign({},p,{score:+s.toFixed(2)});
 }).sort((a,b)=>b.score-a.score);
}
function simpleRisk(project){let r=0; if((project.budget||0)>50000) r+=2; if(/ูุนุงููุฉ|ุชุฌูุน|ููุฑุฌุงู/.test(project.title||'')) r+=1; return {score:r,level:r>=3?'ูุฑุชูุน':r==2?'ูุชูุณุท':'ููุฎูุถ'};}
function smartEnrich(row){row._vision=classifyVision((row.title||'')+' '+(row.note||'')); row._matches=matchPartners({title:row.title,note:row.note,region:row.region,budget:+row.budget||0}); row._risk=simpleRisk({title:row.title,budget:+row.budget||0});}

/* ุฎุฑูุทุฉ GeoJSON */
async function tryLoadGeo(){
 const status=$('#geoStatus'), list=$('#geoList'); list.innerHTML=''; status.textContent='ูุญุงููุฉ ุชุญููู regions.geojson...';
 try{
  const res=await fetch('./regions.geojson?ts='+(Date.now())); if(!res.ok) throw new Error('HTTP '+res.status);
  const geo=await res.json(); const features=geo.features||[]; if(!features.length){status.textContent='ุงูููู ุจูุง ููุฒุงุช.';return;}
  status.textContent='ุชู ุงูุชุญููู: '+features.length+' ููุทูุฉ.';
  list.innerHTML=features.map((f,i)=>{const n=(f.properties&&(f.properties.name_ar||f.properties.name||f.properties.NAME))||('ููุทูุฉ #'+(i+1)); return `<button class="rounded-xl border border-steel-200 px-3 py-2 hover:border-brand-600 text-right" data-region="${n}">${n}</button>`;}).join('');
  list.querySelectorAll('button').forEach(btn=>btn.addEventListener('click',()=>{const n=btn.getAttribute('data-region'); $('#selRegion').textContent=n; $('#kpiJobs').textContent=Math.floor(Math.random()*300)+50; $('#kpiGrants').textContent=Math.floor(Math.random()*100)+10; $('#kpiVols').textContent=Math.floor(Math.random()*1000)+100; }));
 }catch(e){ status.textContent='ุชุนุฐุฑ ุงูุชุญููู. ุงุฑูุน regions.geojson ุจุฌูุงุฑ index.html.'; }
}
$('#reloadGeo').addEventListener('click',tryLoadGeo);

/* ุงููุซุงุฆู/ุงูุฅุนุฏุงุฏุงุช */
async function loadConfigs(){
 const el=$('#cfgList'); el.innerHTML='';
 if(typeof EMBED_BUNDLE==='object'&&EMBED_BUNDLE){
  const names=Object.keys(EMBED_BUNDLE);
  el.innerHTML=names.map(n=>`<li class='rounded-xl border border-steel-200 bg-white px-3 py-2'><div class='font-semibold'>${n}</div><div class='text-xs text-slate-600'>Tabs: ${(EMBED_BUNDLE[n].tabs||[]).length} โ Workflow: ${(EMBED_BUNDLE[n].workflow||[]).length} ุฎุทูุฉ</div></li>`).join('');
  return;
 }
 try{
  const r=await fetch('./config_accounts_bundle.json?ts='+(Date.now()));
  if(r.ok){
   const bundle=await r.json(); const names=Object.keys(bundle);
   el.innerHTML=names.map(n=>`<li class='rounded-xl border border-steel-200 bg-white px-3 py-2'><div class='font-semibold'>${n}</div><div class='text-xs text-slate-600'>Tabs: ${(bundle[n].tabs||[]).length} โ Workflow: ${(bundle[n].workflow||[]).length} ุฎุทูุฉ</div></li>`).join('');
   return;
  }
 }catch(_){}
 el.innerHTML=`<li class='text-sm text-steel-600'>ูุง ุชูุฌุฏ ุญุฒูุฉ ุฎุงุฑุฌูุฉ.</li>`;
}
$('#reloadCfg').addEventListener('click',loadConfigs);

/* ุฃุฏูุงุช ุงููููุณูู: ููุก/ุชูุฑูุบ/ุทุจุงุนุฉ/ุณูููู/ุฏุงูู/ุฏูุฑ */
function seed(){
 if(!state.account) return alert('ุงุฎุชุฑ ุญุณุงุจุงู ุฃููุงู');
 const acc=state.account, push=(tab,rows)=>{state.rows[acc+'::'+tab]=rows;};
 (EMBED_TABS[acc]||[]).forEach(tab=>{
  switch(tab){
   case'ุงููุจุงุฏุฑุงุช':case'ุงููุดุงุฑูุน':push(tab,[{title:'ูุจุงุฏุฑุฉ ุชุดุฌูุฑ ุงูุฃุญูุงุก',owner:acc,budget:'150000',region:'ุญุงุฆู',status:'ุฌุงุฑูุฉ'},{title:'ุจุฑูุงูุฌ ุชูููู ุงูุดุจุงุจ',owner:acc,budget:'80000',region:'ุงูุฑูุงุถ',status:'ููุชููุฉ'}]); break;
   case'ุงููุฑุต':case'ุทูุจุงุช ุงูุชูููู':push(tab,[{title:'ุชูููู ููุตุฉ ุชุนููููุฉ',cat:'ุชุนูููู',amount:'120000',state:'ููุชูุญุฉ'}]); break;
   case'ุงูุฑุนุงูุงุช':push(tab,[{title:'ุฑุนุงูุฉ ููุชูู ูุทูู',cat:'ูุนุงููุงุช',amount:'70000',state:'ููุฏ ุงููุฑุงุฌุนุฉ'}]); break;
   case'ุงูุชุตุงุฑูุญ':case'ุงูุชุตุงุฑูุญ ุงูุฃูููุฉ':push(tab,[{org:'ุฌูุนูุฉ ุชููููุฉ',type:'ูุนุงููุฉ ุฌูุงููุฑูุฉ',date:'2025-11-15',status:'ูุนุชูุฏ'}]); break;
   case'ุงููุนุงููุงุช':push(tab,[{name:'ููุชุฏู ุงูุงุจุชูุงุฑ',venue:'ูุงุนุฉ ุงููุฏููุฉ',date:'2025-12-01',status:'ูุฌุฏููุฉ'}]); break;
   case'ุงูุชุฏุฑูุจ':case'ุงูุชุฏุฑูุจ ุงูุชุนุงููู':push(tab,[{program:'ููุงุฑุงุช ุฑูููุฉ',hours:'40',type:'ูุฌุชูุนู',status:'ููุชูุญ'}]); break;
   case'ุงูุชุทูุน':push(tab,[{title:'ุชูุธูู ุญููุฉ ุซูุงููุฉ',org:'ูุคุณุณุฉ ูุทููุฉ',hours:'6',date:'2025-10-25'}]); break;
   case'ุงูุงุณุชุดุงุฑุงุช':push(tab,[{topic:'ุญูููุฉ ุฌูุนูุงุช',benef:'ููุธูุฉ ุบูุฑ ุฑุจุญูุฉ',date:'2025-11-05',result:'ุชูุฑูุฑ ุฃููู'}]); break;
   case'ุงููุคุดุฑุงุช':case'ุชูุงุฑูุฑ ุงูุฃุซุฑ':push(tab,[{kpi:'ุนุฏุฏ ุงููุณุชููุฏูู',project:'ุชูููู ุงูุดุจุงุจ',value:'120',unit:'ุดุฎุต'}]); break;
   case'ุงููุญูุธุฉ':push(tab,[{benef:'ูุดุฑูุน ุชูููู ุงูุดุจุงุจ',amount:'200000',kind:'ุชูููู',note:'ุฏูุนุฉ ุฃููู'}]); break;
   case'ESG':push(tab,[{pillar:'E',metric:'ุงูุจุนุงุซุงุช CO2',value:'34',unit:'ุทู'},{pillar:'S',metric:'ุณุงุนุงุช ุชุฏุฑูุจ',value:'420',unit:'ุณุงุนุฉ'}]); break;
   case'ุชูุงุฑูุฑ CSRD':push(tab,[{topic:'E1-Climate',req:'ุฅูุตุงุญ ุงูุงูุจุนุงุซุงุช',status:'ูุณูุฏุฉ',note:'ูููุต ูุฑุงุฌุนุฉ ูุงููููุฉ'}]); break;
   case'ุงูุชูุงูู ูุงูุจูุงูุงุช':push(tab,[{endpoint:'/api/projects',method:'GET',scope:'ูุฑุงุกุฉ',status:'ููุนูู'},{endpoint:'/api/wallet',method:'POST',scope:'ุชุญููู',status:'ููููุฏ'}]); break;
   default:push(tab,[{title:tab+' โ ุณุฌู ุชุฌุฑูุจู',note:'...',date:'2025-10-19',status:'โ'}]);
  }
 });
 Object.keys(state.rows).forEach(k=>{if(k.startsWith(acc+'::')&&(k.endsWith('ุงููุจุงุฏุฑุงุช')||k.endsWith('ุงููุดุงุฑูุน'))){(state.rows[k]||[]).forEach(smartEnrich);}});
 save(); buildTabs(acc); refreshKPIs();
}
function clearAll(){state={account:state.account,rows:{},roles:state.roles||{},currentRole:state.currentRole||'ุงููุดุฑู ุงูุนุงู',session:state.session}; save(); buildTabs(state.account); refreshKPIs();}
$('#seedBtn').addEventListener('click',seed);
$('#clearBtn').addEventListener('click',clearAll);
$('#printBtn')?.addEventListener('click',()=>window.print());
$('#toggleDark').addEventListener('click',()=>{const on=!document.documentElement.hasAttribute('data-theme'); document.documentElement.toggleAttribute('data-theme',on);});
$('#roleSelect').addEventListener('change',e=>{state.currentRole=e.target.value; save(); if(state.account){buildTabs(state.account);}});
document.getElementById('toggleGov')?.addEventListener('click',()=>{const b=document.body; const isGov=b.getAttribute('data-variant')==='gov'; if(isGov)b.removeAttribute('data-variant'); else b.setAttribute('data-variant','gov');});

/* ุฅููุงุน ุงูุตูุญุฉ */
function buildAccountAndMaybeOpen(){
 buildAccountGrid(EMBED_ACCOUNTS);
 if(state.session){$('#logoutBtn').classList.remove('hidden'); $('#fUser').value=state.session.user; $('#fAccount').value=state.session.acc;}
 if(state.session && state.account){openDashboard(state.account);}
}
buildAccountAndMaybeOpen();
</script>

</body>
</html>
