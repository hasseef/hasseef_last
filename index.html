<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>منصة حصيف الوطنية للتكامل التنموي</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config={theme:{extend:{colors:{
 brand:{50:'#eefdfb',100:'#cff7f3',200:'#a0eee6',300:'#6de2d8',400:'#36d0c7',500:'#0ea5a4',600:'#0f8f8d',700:'#0f766e',800:'#0b5953',900:'#083f3a'},
 gov:{50:'#eff6ff',100:'#dbeafe',300:'#93c5fd',500:'#2563eb',600:'#1d4ed8',700:'#1e40af'},
 steel:{50:'#f8fafc',100:'#f1f5f9',200:'#e2e8f0',300:'#cbd5e1',500:'#64748b',700:'#334155',900:'#0f172a'}
},fontFamily:{sans:['Tajawal','ui-sans-serif','system-ui']}}},darkMode:['class','[data-theme="dark"]']};
</script>
<style>
:root{--brand:#0ea5a4;--gov:#2563eb}
*{box-sizing:border-box} body{font-family:'Tajawal',system-ui}
.section{scroll-margin-top:84px}
.card{border:1px solid #e2e8f0;background:#fff;border-radius:1.25rem}
.badge{font-size:.72rem;border-radius:999px;background:#ecfeff;color:#065f46;padding:.15rem .6rem;border:1px solid #99f6e4}
.kpi{border:1px solid #e2e8f0;background:#fff;border-radius:1rem;padding:.7rem}
.kpi-label{font-size:.7rem;color:#64748b}.kpi-value{margin-top:.1rem;font-size:1.4rem;font-weight:900;color:#047857}
.btn{padding:.55rem .9rem;border-radius:.9rem;border:1px solid #e2e8f0;background:#fff}
.btn-primary{background:var(--brand);color:#fff;border-color:var(--brand)}
.btn-gov{background:var(--gov);color:#fff;border-color:var(--gov)}
.nav-pill{padding:.45rem .8rem;border-radius:999px;border:1px solid #e2e8f0;background:#fff}
.nav-pill[aria-current="page"]{background:var(--brand);color:#fff;border-color:var(--brand)}
.action{font-size:.75rem}.action.edit{color:#1d4ed8}.action.del{color:#b91c1c}
.smart-chip{display:inline-flex;gap:.3rem;align-items:center;border-radius:999px;border:1px dashed #94a3b8;padding:.15rem .5rem;font-size:.72rem;color:#334155;background:#f8fafc}
.logo{height:32px}.glass{backdrop-filter:saturate(160%) blur(8px);background:rgba(255,255,255,.72)}
.field{display:flex;flex-direction:column;gap:.35rem}.input{border:1px solid #e2e8f0;border-radius:.9rem;padding:.7rem .9rem;background:#fff}
.checkbox{width:1rem;height:1rem;border:1px solid #cbd5e1;border-radius:.4rem}

/* سكين العرض الحكومي */
:root[data-variant="gov"]{--brand:#0ea5a4;--gov:#2563eb}
[data-variant="gov"] .nav-pill[aria-current="page"],[data-variant="gov"] .btn-primary{background:var(--gov);border-color:var(--gov)}
[data-variant="gov"] .badge{background:#eef2ff;border-color:#c7d2fe;color:#1e40af}
[data-variant="gov"] header .ribbon{background:linear-gradient(90deg,#1e40af,#2563eb);color:#fff;font-weight:800;letter-spacing:.5px}
[data-variant="gov"] header .ribbon small{opacity:.9;font-weight:600}
[data-variant="gov"] .card{border-color:#dbeafe}
[data-variant="gov"] .kpi-value{color:#1e40af}
[data-variant="gov"] #consoleBar .glass{border-color:#bfdbfe}
</style>
</head>
<body class="bg-steel-50 text-steel-900" data-variant="gov">

<!-- HEADER -->
<header class="pt-6 pb-4">
  <div class="mx-auto max-w-6xl px-4">
    <div class="flex items-center justify-between gap-3">
      <div class="flex items-center gap-2">
        <!-- يسار: رؤية + تلبية -->
        <img class="logo" alt="Vision 2030"
          src='data:image/svg+xml;utf8,<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" width="200" height="60"><rect width="200" height="60" rx="8" fill="%23eef2ff"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="Tajawal,Arial" font-weight="700" font-size="18" fill="%231e40af">VISION 2030</text></svg>'/>
        <img class="logo" alt="Talbiya"
          src='data:image/svg+xml;utf8,<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" width="180" height="60"><rect width="180" height="60" rx="8" fill="%23ecfeff"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="Tajawal,Arial" font-weight="700" font-size="18" fill="%230f766e">TALBIYA</text></svg>'/>
      </div>
      <div class="flex items-center gap-2">
        <!-- يمين: شعار حصيف -->
        <img class="logo" alt="Hasseef"
          src='data:image/svg+xml;utf8,<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" width="180" height="60"><rect width="180" height="60" rx="8" fill="%23d1fae5"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="Tajawal,Arial" font-weight="900" font-size="20" fill="%23047557">حـصـيـف</text></svg>'/>
      </div>
    </div>

    <!-- شريط عرض حكومي رسمي -->
    <div class="ribbon mt-3 rounded-2xl px-4 py-2 flex items-center justify-between shadow">
      <div class="flex items-center gap-3">
        <span>📘 عرض حكومي رسمي</span>
        <small>نسخة مُهيّأة للعروض أمام الجهات العليا</small>
      </div>
      <img class="logo" alt="Hasseef"
        src='data:image/svg+xml;utf8,<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" width="180" height="60"><rect width="180" height="60" rx="8" fill="%23d1fae5"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="Tajawal,Arial" font-weight="900" font-size="20" fill="%23047557">حـصـيـف</text></svg>'/>
    </div>

    <div class="mt-4 flex items-center justify-between gap-3">
      <nav class="flex items-center gap-2 text-sm">
        <a href="#login" class="nav-pill" data-nav="login">الدخول</a>
        <a href="#docs" class="nav-pill" data-nav="docs">الوثائق</a>
        <a href="#map" class="nav-pill" data-nav="map">الخريطة</a>
      </nav>
      <div class="flex items-center gap-2">
        <button id="toggleDark" class="btn">وضع داكن</button>
        <button id="toggleGov" class="btn">وضع حكومي</button>
        <button id="logoutBtn" class="btn hidden">تسجيل خروج</button>
      </div>
    </div>
  </div>
</header>

<!-- LOGIN -->
<section id="view-login" class="section">
  <div class="mx-auto max-w-3xl px-4">
    <div class="card p-6 lg:p-8 shadow-md">
      <h1 class="text-2xl lg:text-3xl font-black">تسجيل الدخول إلى منصة حصيف</h1>
      <p class="mt-2 text-steel-700">نسخة تجريبية محلية — لا تُرسل أي بيانات لخادم. للعرض فقط.</p>
      <form id="loginForm" class="mt-6 grid md:grid-cols-2 gap-4">
        <div class="field md:col-span-1">
          <label class="text-sm font-semibold">اسم المستخدم</label>
          <input id="fUser" type="text" class="input" placeholder="example@domain.sa" required />
        </div>
        <div class="field md:col-span-1">
          <label class="text-sm font-semibold">كلمة المرور</label>
          <input id="fPass" type="password" class="input" placeholder="••••••••" required />
        </div>
        <div class="field md:col-span-2">
          <label class="text-sm font-semibold">اختيار الحساب</label>
          <select id="fAccount" class="input"></select>
        </div>
        <div class="md:col-span-2 flex items-center justify-between">
          <label class="flex items-center gap-2 text-sm text-steel-700"><input id="fRemember" type="checkbox" class="checkbox"/> تذكّرني</label>
          <button class="btn btn-primary" type="submit">دخول</button>
        </div>
      </form>
      <div id="loginMsg" class="mt-3 text-sm text-red-700 hidden">تحقق من البيانات.</div>
    </div>
  </div>
</section>

<!-- HOME: اختيار الحساب -->
<section id="view-home" class="section hidden">
  <div class="mx-auto max-w-6xl px-4">
    <div class="card p-5 lg:p-6 shadow-md">
      <div class="flex items-start justify-between gap-3">
        <div>
          <h2 class="text-2xl lg:text-3xl font-black">اختر حسابًا للعرض</h2>
          <p class="mt-2 text-steel-700">انتقل إلى لوحات الحسابات بخدمات كاملة وصلاحيات مفعّلة.</p>
        </div>
      </div>
      <div id="accountGrid" class="mt-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </div>
  </div>
</section>

<!-- DASHBOARD -->
<section id="view-dashboard" class="section hidden">
  <div class="mx-auto max-w-6xl px-4">
    <div class="flex items-center justify-between">
      <div>
        <h2 id="dashTitle" class="text-xl lg:text-2xl font-extrabold">لوحة حساب —</h2>
        <p id="dashLead" class="text-steel-600 mt-1">سجلات وخدمات متكاملة + طبقة ذكاء محلية.</p>
      </div>
      <div class="flex items-center gap-2">
        <a href="#home" class="btn">⬅ تغيير الحساب</a>
        <button id="printBtn" class="btn btn-primary">تقرير PDF</button>
      </div>
    </div>
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mt-5">
      <div class="kpi"><div class="kpi-label">مبادرات/مشاريع</div><div id="kpiInits" class="kpi-value">0</div></div>
      <div class="kpi"><div class="kpi-label">سجلات</div><div id="kpiOps" class="kpi-value">0</div></div>
      <div class="kpi"><div class="kpi-label">الرصيد</div><div id="kpiBal" class="kpi-value">0</div></div>
      <div class="kpi"><div class="kpi-label">مؤشر الأثر</div><div id="kpiImpact" class="kpi-value">0</div></div>
    </div>
    <div class="mt-6 flex flex-wrap gap-2" id="tabs"></div>
    <div id="panels" class="mt-4"></div>
  </div>
</section>

<!-- DOCS -->
<section id="view-docs" class="section hidden">
  <div class="mx-auto max-w-6xl px-4">
    <div class="card p-5 lg:p-6 shadow-md">
      <div class="flex items-start justify-between gap-3">
        <div>
          <h2 class="text-2xl font-black">الوثائق والعقود</h2>
          <p class="mt-2 text-steel-600 text-sm">ترتيب القراءة: الحزمة المدمجة أولًا ثم ملف JSON خارجي (إن وُجد).</p>
        </div>
      </div>
      <div class="mt-4 grid grid-cols-1 gap-2">
        <!-- ارفع ملفاتك بأسمائها النهائية بجوار index.html أو عدّل الروابط أدناه -->
        <a class="flex items-center justify-between rounded-xl border border-slate-200 bg-white px-4 py-3 hover:border-brand-600 transition" href="./📘 وثيقة النظام التنفيذي والتقني الشامل لمنصة (1).docx" download><span class="truncate">📘 وثيقة النظام التنفيذي والتقني الشامل لمنصة (1).docx</span><span class="text-xs rounded-full bg-emerald-50 text-emerald-700 px-3 py-1">تنزيل</span></a>
        <a class="flex items-center justify-between rounded-xl border border-slate-200 bg-white px-4 py-3 hover:border-brand-600 transition" href="./الملف القانوني والاستراتيجي الشامل لتفعيل الشراكات في منصة حصيف.docx" download><span class="truncate">الملف القانوني والاستراتيجي الشامل لتفعيل الشراكات في منصة حصيف.docx</span><span class="text-xs rounded-full bg-emerald-50 text-emerald-700 px-3 py-1">تنزيل</span></a>
        <a class="flex items-center justify-between rounded-xl border border-slate-200 bg-white px-4 py-3 hover:border-brand-600 transition" href="./الملف القانوني والاستراتيجي الشامل لتفعيل الشراكات في منصة حصيف (1).docx" download><span class="truncate">الملف القانوني والاستراتيجي الشامل لتفعيل الشراكات في منصة حصيف (1).docx</span><span class="text-xs rounded-full bg-emerald-50 text-emerald-700 px-3 py-1">تنزيل</span></a>
        <a class="flex items-center justify-between rounded-xl border border-slate-200 bg-white px-4 py-3 hover:border-brand-600 transition" href="./شراكة علمية استراتيجية بين الجامعات ومنصة حصيف.docx" download><span class="truncate">شراكة علمية استراتيجية بين الجامعات ومنصة حصيف.docx</span><span class="text-xs rounded-full bg-emerald-50 text-emerald-700 px-3 py-1">تنزيل</span></a>
        <a class="flex items-center justify-between rounded-xl border border-slate-200 bg-white px-4 py-3 hover:border-brand-600 transition" href="./شراكة استراتيجية وطنية مع هيئات تطوير المناطق .docx" download><span class="truncate">شراكة استراتيجية وطنية مع هيئات تطوير المناطق .docx</span><span class="text-xs rounded-full bg-emerald-50 text-emerald-700 px-3 py-1">تنزيل</span></a>
        <a class="flex items-center justify-between rounded-xl border border-slate-200 bg-white px-4 py-3 hover:border-brand-600 transition" href="./فرصة وقفية استراتيجية.pdf" download><span class="truncate">فرصة وقفية استراتيجية.pdf</span><span class="text-xs rounded-full bg-emerald-50 text-emerald-700 px-3 py-1">تنزيل</span></a>
      </div>
      <hr class="my-6 border-steel-200"/>
      <h3 class="font-extrabold text-lg">إعدادات الحسابات (JSON)</h3>
      <div class="mt-3"><button id="reloadCfg" class="btn">إعادة التحميل</button></div>
      <ul id="cfgList" class="mt-3 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 text-sm"></ul>
    </div>
  </div>
</section>

<!-- MAP -->
<section id="view-map" class="section hidden">
  <div class="mx-auto max-w-6xl px-4">
    <div class="card p-5 lg:p-6 shadow-md">
      <div class="flex items-center justify-between">
        <div>
          <h2 class="text-2xl font-black">الخريطة والمؤشرات المناطقية</h2>
          <p class="mt-1 text-steel-600 text-sm">ارفع ملف <code>regions.geojson</code> بجوار index.html وسيُقرأ تلقائيًا.</p>
        </div>
        <button id="reloadGeo" class="btn">إعادة تحميل</button>
      </div>
      <div class="mt-4 grid lg:grid-cols-3 gap-4">
        <div class="lg:col-span-2">
          <div id="mapStage" class="rounded-2xl border border-steel-200 bg-gradient-to-tr from-emerald-50 to-steel-50 p-6 h-[360px] overflow-auto">
            <div id="geoStatus" class="text-sm text-steel-600">لم يتم تحميل GeoJSON بعد.</div>
            <ul id="geoList" class="mt-3 grid grid-cols-2 gap-2 text-sm"></ul>
          </div>
        </div>
        <div>
          <div class="kpi"><div class="kpi-label">منطقة مختارة</div><div id="selRegion" class="kpi-value">—</div></div>
          <div class="grid grid-cols-3 gap-2 mt-2">
            <div class="kpi"><div class="kpi-label">وظائف</div><div id="kpiJobs" class="kpi-value">—</div></div>
            <div class="kpi"><div class="kpi-label">منح</div><div id="kpiGrants" class="kpi-value">—</div></div>
            <div class="kpi"><div class="kpi-label">متطوعون</div><div id="kpiVols" class="kpi-value">—</div></div>
          </div>
          <p class="mt-3 text-xs text-steel-500">سيتم استبدال هذه القائمة بخريطة تفاعلية كاملة حال إتاحة ملف رسمي.</p>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Console -->
<div class="h-20"></div>
<div id="consoleBar" class="fixed bottom-0 inset-x-0 z-50">
  <div class="mx-auto max-w-6xl px-4">
    <div class="glass border border-steel-200 rounded-t-2xl px-3 py-2 shadow">
      <div class="flex flex-wrap items-center gap-2">
        <span class="text-sm font-bold text-steel-700">الوضع التجريبي</span>
        <button id="seedBtn" class="btn">ملء بيانات</button>
        <button id="clearBtn" class="btn">تفريغ</button>
        <div class="grow"></div>
        <label class="text-sm">الدور:
          <select id="roleSelect" class="rounded-xl border border-steel-200 px-2 py-1 text-sm">
            <option>المشرف العام</option>
            <option>مدير النظام</option>
            <option>مشغّل</option>
            <option>مراقب</option>
            <option>زائر</option>
            <option>ممثل جهة شريكة</option>
          </select>
        </label>
        <label class="text-sm">المسار: <span id="routeLabel" class="font-extrabold text-brand-600">#login</span></label>
      </div>
    </div>
  </div>
</div>

<!-- EMBEDDED BUNDLE: تبويبات وتدفّقات كل حساب -->
<script>
const EMBED_BUNDLE={
 "الأفراد":{tabs:["المبادرات","الفرص","التطوع","التدريب","التوظيف","الفعاليات","المحفظة","التقارير"],
  workflow:[{step:"التلقّي",role:"مشغّل",policy:"مراجعة بيانات المبادرة"},
            {step:"مواءمة الرؤية",role:"مدير النظام",policy:"تصنيف تلقائي + اعتماد بشري"},
            {step:"تعزيز علمي",role:"ممثل جهة شريكة",policy:"جامعة/مركز بحثي"},
            {step:"تمويل/رعاية",role:"المشرف العام",policy:"سير موافقات متعدد"},
            {step:"تنفيذ",role:"مشغّل",policy:"مهام وميزانية"},
            {step:"أثر وتقارير",role:"مراقب",policy:"مؤشرات ونشر مختصر"}]},
 "القطاع الخاص":{tabs:["المشاريع","الرعايات","الوظائف","التدريب التعاوني","الاستشارات","المرافق","ESG","تقارير CSRD","المحفظة","التقارير"],
  workflow:[{step:"طلب رعاية/CSR",role:"مشغّل",policy:"مطابقة معايير CSR"},
            {step:"مراجعة قانونية/مالية",role:"مدير النظام",policy:"نماذج عقود جاهزة"},
            {step:"توقيع رقمي",role:"المشرف العام",policy:"اعتماد نهائي"},
            {step:"متابعة الأداء",role:"مراقب",policy:"ESG/CSRD + KPIs"}]},
 "القطاع غير الربحي":{tabs:["المبادرات","طلبات التمويل","الرعايات","التطوع","التدريب","الفعاليات","التصاريح","المحفظة","التقارير"],
  workflow:[{step:"إدراج مشروع",role:"مشغّل",policy:"ملف أثر مختصر"},
            {step:"مطابقة مانحين",role:"مدير النظام",policy:"تفضيلات التمويل"},
            {step:"جمع التبرعات",role:"المشرف العام",policy:"محفظة وتوثيق"},
            {step:"التنفيذ والأثر",role:"مشغّل",policy:"تقارير شفافة"}]},
 "الجامعات":{tabs:["الأبحاث","الاستشارات","التدريب التعاوني","الحلول","المرافق","الفعاليات","المؤشرات","المحفظة","التقارير"],
  workflow:[{step:"استلام طلب تعزيز",role:"ممثل جهة شريكة",policy:"تقييم مختصر"},
            {step:"مراجعة لجنة",role:"مدير النظام",policy:"قرار اعتماد/تحسين"},
            {step:"تقرير علمي",role:"مراقب",policy:"نشر الملخص"}]},
 "الجهات الحكومية":{tabs:["التحديات","الحلول المستلمة","المشاريع","التصاريح","الفعاليات","المؤشرات","التقييمات","المحفظة","التقارير"],
  workflow:[{step:"تسجيل تحدٍّ",role:"مشغّل",policy:"نطاق/مؤشرات"},
            {step:"مطارحة حلول",role:"ممثل جهة شريكة",policy:"منصة حلول"},
            {step:"اعتماد وتنفيذ",role:"مدير النظام",policy:"تصريح ومتابعة"}]},
 "الجهات التمويلية":{tabs:["طلبات التمويل","الرعايات","المحفظة","تقارير الأثر","التقارير المالية","التقارير"],
  workflow:[{step:"استلام الطلب",role:"مشغّل",policy:"تصفية مبدئية"},
            {step:"مراجعة لجنة",role:"مدير النظام",policy:"سياسات التمويل"},
            {step:"اعتماد وتحويل",role:"المشرف العام",policy:"دفعات ومحفظة"},
            {step:"تقرير أثر",role:"مراقب",policy:"إغلاق"}]},
 "إمارة المنطقة":{tabs:["التصاريح الأمنية","لوحة التنمية","رعايات الأمير","الفعاليات","المؤشرات","المحافظات","المحفظة","التقارير"],
  workflow:[{step:"طلب تصريح",role:"مشغّل",policy:"تحقق أمني"},
            {step:"اعتماد",role:"مدير النظام",policy:"اشتراطات تنظيمية"},
            {step:"متابعة",role:"مراقب",policy:"تقرير ختامي"}]},
 "هيئات التطوير":{tabs:["برامج المدن","المشاريع","الفعاليات","التصاريح","المؤشرات","المحفظة","الشراكات","التقارير"],
  workflow:[{step:"مواءمة برنامج",role:"مدير النظام",policy:"أهداف المدينة"},
            {step:"تنفيذ",role:"مشغّل",policy:"الإنفاق والجدول"},
            {step:"أثر حضري",role:"مراقب",policy:"KPIs مكانية"}]},
 "إدارة المنصة":{tabs:["الحسابات والحوكمة","الصلاحيات","التكامل والبيانات","الإشعارات","الدعم","التقارير","إدارة الصلاحيات والأدوار"],
  workflow:[{step:"إنشاء حساب",role:"المشرف العام",policy:"تهيئة وصلاحيات"},
            {step:"ربط تكاملي",role:"مدير النظام",policy:"API/Webhooks"},
            {step:"حوكمة",role:"مراقب",policy:"تدقيق وأثر"}]}
};
</script>

<!-- APP SCRIPT: التوجيه، الجلسة، الأدوار، اللوحات، الذكاء المحلي، الوثائق، الخريطة -->
<script>
const $=(s,c=document)=>c.querySelector(s); const $$=(s,c=document)=>Array.from(c.querySelectorAll(s));
const views={login:$('#view-login'),home:$('#view-home'),dashboard:$('#view-dashboard'),docs:$('#view-docs'),map:$('#view-map')};
function setRoute(r){Object.entries(views).forEach(([k,el])=>el.classList.toggle('hidden',k!==r)); $$('[data-nav]').forEach(a=>a.setAttribute('aria-current',a.getAttribute('data-nav')===r?'page':null)); $('#routeLabel').textContent='#'+r; if(r==='map')tryLoadGeo(); if(r==='docs')loadConfigs();}
addEventListener('hashchange',()=>{const r=(location.hash||'#login').replace('#',''); setRoute(r in views?r:'login');});
setRoute((location.hash||'#login').replace('#','') in views?(location.hash||'#login').replace('#',''):'login');

const KEY='hp_portal_final_gov';
let state=(()=>{try{return JSON.parse(localStorage.getItem(KEY))}catch(_){} })()||{account:null,rows:{},roles:{map:{}},currentRole:'المشرف العام',session:null};
function save(){localStorage.setItem(KEY,JSON.stringify(state));}
const ROLES=['المشرف العام','مدير النظام','مشغّل','مراقب','زائر','ممثل جهة شريكة'];
const PERMS=['إدارة الحسابات','اعتماد المشاريع','إدارة الرعايات','تعديل البيانات','توليد التقارير','وصول API'];
const DEFAULT_ROLE_MAP={
 'المشرف العام':['إدارة الحسابات','اعتماد المشاريع','إدارة الرعايات','تعديل البيانات','توليد التقارير','وصول API'],
 'مدير النظام':['إدارة الحسابات','اعتماد المشاريع','إدارة الرعايات','تعديل البيانات','توليد التقارير','وصول API'],
 'مشغّل':['اعتماد المشاريع','إدارة الرعايات','تعديل البيانات','توليد التقارير'],
 'مراقب':['توليد التقارير'],
 'زائر':[],
 'ممثل جهة شريكة':['اعتماد المشاريع','توليد التقارير']
};
ROLES.forEach(r=>{state.roles.map[r]=state.roles.map[r]||{}; PERMS.forEach(p=>state.roles.map[r][p]=state.roles.map[r][p]??DEFAULT_ROLE_MAP[r].includes(p));});
$('#roleSelect').value=state.currentRole; function can(p){return !!(state.roles.map?.[state.currentRole]?.[p]);}

const EMBED_ACCOUNTS=Object.keys(EMBED_BUNDLE);
const EMBED_TABS=Object.fromEntries(Object.entries(EMBED_BUNDLE).map(([k,v])=>[k,v.tabs||[]]));

const fAccount=$('#fAccount'); fAccount.innerHTML=EMBED_ACCOUNTS.map(a=>`<option>${a}</option>`).join('');
$('#loginForm').addEventListener('submit',e=>{
 e.preventDefault();
 const user=$('#fUser').value.trim(), pass=$('#fPass').value.trim(), acc=$('#fAccount').value;
 if(!user||!pass){$('#loginMsg').classList.remove('hidden');return;}
 state.session={user,acc,role:state.currentRole,ts:Date.now(),remember:$('#fRemember').checked}; state.account=acc; save();
 $('#logoutBtn').classList.remove('hidden'); location.hash='#dashboard';
});
$('#logoutBtn').addEventListener('click',()=>{state.session=null;state.account=null;save();$('#logoutBtn').classList.add('hidden');location.hash='#login';});

function buildAccountGrid(list){
 const grid=$('#accountGrid');
 grid.innerHTML=list.map(n=>`
  <a href="#dashboard" class="text-start rounded-2xl border border-steel-200 bg-white p-4 hover:border-brand-600 hover:shadow-md transition" data-name="${n}">
    <div class="flex items-center justify-between gap-2">
      <h3 class="font-extrabold">حساب ${n}</h3>
      <span class="badge">كامل الخدمات</span>
    </div>
    <p class="mt-2 text-sm text-steel-700">لوحات ${n} وصلاحيات وفق الدور.</p>
  </a>`).join('');
 $$('#accountGrid a').forEach(b=>b.addEventListener('click',()=>openDashboard(b.dataset.name)));
}
buildAccountGrid(EMBED_ACCOUNTS);

function openDashboard(name){
 if(!state.session){location.hash='#login';return;}
 state.account=name||state.session.acc; save();
 $('#dashTitle').textContent='لوحة حساب — '+state.account;
 buildTabs(state.account); refreshKPIs(); setRoute('dashboard');
}

function getSchema(tab){
 switch(tab){
  case'المبادرات':case'المشاريع':return[{name:'title',label:'العنوان'},{name:'owner',label:'الجهة'},{name:'budget',label:'الميزانية (ر.س)'},{name:'region',label:'المنطقة'},{name:'status',label:'الحالة'}];
  case'الفرص':case'طلبات التمويل':return[{name:'title',label:'العنوان'},{name:'cat',label:'التصنيف'},{name:'amount',label:'المبلغ (ر.س)'},{name:'state',label:'الحالة'}];
  case'الرعايات':return[{name:'title',label:'العنوان'},{name:'cat',label:'التصنيف'},{name:'amount',label:'المبلغ (ر.س)'},{name:'state',label:'الحالة'}];
  case'التصاريح':case'التصاريح الأمنية':return[{name:'org',label:'الجهة'},{name:'type',label:'نوع النشاط'},{name:'date',label:'التاريخ'},{name:'status',label:'الحالة'}];
  case'الفعاليات':return[{name:'name',label:'اسم الفعالية'},{name:'venue',label:'المكان'},{name:'date',label:'التاريخ'},{name:'status',label:'الحالة'}];
  case'التدريب':case'التدريب التعاوني':return[{name:'program',label:'البرنامج'},{name:'hours',label:'الساعات'},{name:'type',label:'النوع'},{name:'status',label:'الحالة'}];
  case'التطوع':return[{name:'title',label:'عنوان الفرصة'},{name:'org',label:'الجهة المنظمة'},{name:'hours',label:'الساعات'},{name:'date',label:'التاريخ'}];
  case'الاستشارات':return[{name:'topic',label:'الموضوع'},{name:'benef',label:'الجهة المستفيدة'},{name:'date',label:'التاريخ'},{name:'result',label:'النتيجة'}];
  case'المؤشرات':case'تقارير الأثر':return[{name:'kpi',label:'المؤشر'},{name:'project',label:'المشروع/المبادرة'},{name:'value',label:'القيمة'},{name:'unit',label:'الوحدة'}];
  case'المحفظة':return[{name:'benef',label:'الجهة المستفيدة'},{name:'amount',label:'المبلغ (ر.س)'},{name:'kind',label:'نوع العملية'},{name:'note',label:'وصف'}];
  case'ESG':return[{name:'pillar',label:'المحور'},{name:'metric',label:'المؤشر'},{name:'value',label:'القيمة'},{name:'unit',label:'الوحدة'}];
  case'تقارير CSRD':return[{name:'topic',label:'الموضوع'},{name:'req',label:'المطلب'},{name:'status',label:'الحالة'},{name:'note',label:'ملاحظة'}];
  case'التكامل والبيانات':return[{name:'endpoint',label:'نقطة التكامل'},{name:'method',label:'الطريقة'},{name:'scope',label:'النطاق'},{name:'status',label:'الحالة'}];
  case'التقييمات':return[{name:'subject',label:'الموضوع'},{name:'score',label:'التقييم'},{name:'date',label:'التاريخ'},{name:'note',label:'ملاحظة'}];
  case'الشراكات':return[{name:'partner',label:'الشريك'},{name:'type',label:'النوع'},{name:'date',label:'التاريخ'},{name:'status',label:'الحالة'}];
  case'الحسابات والحوكمة':return[{name:'account',label:'الحساب'},{name:'owner',label:'المالك'},{name:'status',label:'الحالة'},{name:'note',label:'ملاحظة'}];
  default:return[{name:'title',label:'العنوان'},{name:'note',label:'وصف'},{name:'date',label:'التاريخ'},{name:'status',label:'الحالة'}];
 }
}
function panelHeaderActions(tab,key){
 const addBtn=`<button class="btn btn-primary" data-add="${key}" ${!can('تعديل البيانات')?'disabled':''}>+ إضافة</button>`;
 const exportBtn=`<button class="btn" data-export="${key}" ${!can('توليد التقارير')?'disabled':''}>تصدير CSV</button>`;
 const wfBtn=(tab==='طلبات التمويل'||tab==='الرعايات')?`<button class="btn btn-gov" data-wf="${key}" ${!can('إدارة الرعايات')?'disabled':''}>سير الموافقات</button>`:'';
 return `${wfBtn}${addBtn}${exportBtn}`;
}
function renderSmartChip(row){
 const tags=(row._vision||[]).map(v=>v.code).join('·')||'—';
 const top=(row._matches||[])[0]; const partner=top?`${top.name} (${(top.score*100).toFixed(0)}%)`:'—';
 const risk=row._risk?row._risk.level:'—';
 return `<span class="smart-chip">🎯 ${tags} • 🤝 ${partner} • ⚠️ ${risk}</span>`;
}
function rolesPanel(){
 const RO=ROLES; const th=['صلاحية/دور'].concat(RO).map(h=>`<th class="px-3 py-2 text-right">${h}</th>`).join('');
 const rows=PERMS.map(p=>{
  const tds=RO.map(r=>{
   const checked=state.roles.map[r]?.[p]?'checked':'';
   return `<td class="px-3 py-2"><input type="checkbox" data-role="${r}" data-perm="${p}" ${checked}></td>`;
  }).join('');
  return `<tr><td class="px-3 py-2 font-semibold">${p}</td>${tds}</tr>`;
 }).join('');
 return `
  <div class="card p-4 lg:p-5 shadow-md">
    <div class="flex items-center justify-between gap-2">
      <h3 class="font-extrabold">إدارة الصلاحيات والأدوار</h3>
      <div class="flex items-center gap-2">
        <button id="rolesReset" class="btn">إعادة الضبط</button>
        <button id="rolesSave" class="btn btn-primary">حفظ</button>
      </div>
    </div>
    <div class="mt-3 overflow-x-auto">
      <table class="w-full text-sm border border-steel-200 rounded-xl">
        <thead class="bg-steel-50"><tr>${th}</tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
    <p class="mt-3 text-xs text-steel-500">تُحفظ الصلاحيات محليًا — وتنعكس مباشرة على الأزرار.</p>
  </div>`;
}
function panelTemplate(acc,tab){
 if(tab==='إدارة الصلاحيات والأدوار') return rolesPanel();
 const key=acc+'::'+tab; const schema=getSchema(tab);
 const headers=schema.map(s=>`<th class='text-right py-2'>${s.label}</th>`).join('')+`<th class='text-right py-2'>إجراءات</th>`;
 const hint=(tab==='المبادرات'||tab==='المشاريع')?`<div class='text-xs text-steel-500'>عند إضافة سجل سيظهر شريط ذكاء تلقائيًا (رؤية/شركاء/مخاطر).</div>`:'';
 return `
  <div class="card p-4 lg:p-5 shadow-md">
    <div class="flex items-center justify-between gap-2">
      <div class="flex items-center gap-2"><h3 class="font-extrabold">${tab}</h3><span class="text-xs text-steel-500">${schema.length} حقول</span></div>
      <div class="flex items-center gap-2">${panelHeaderActions(tab,key)}</div>
    </div>
    ${hint}
    <div class="mt-3 overflow-x-auto">
      <table class="w-full text-sm"><thead><tr class="text-steel-600">${headers}</tr></thead><tbody id="tbl::${key}" class="align-top"></tbody></table>
    </div>
  </div>`;
}
function buildTabs(acc){
 const tabs=(EMBED_TABS[acc]||[]);
 $('#tabs').innerHTML=tabs.map((t,i)=>`<button class="tab-btn btn ${i===0?'btn-primary':''}" aria-selected="${i===0?'true':'false'}" data-tab="${t}">${t}</button>`).join('');
 $('#panels').innerHTML=tabs.map((t,i)=>`<div class="panel ${i===0?'':'hidden'}" data-panel="${t}">${panelTemplate(acc,t)}</div>`).join('');
 $$('#tabs .tab-btn').forEach(b=>b.addEventListener('click',()=>switchTab(b.dataset.tab)));
 bindPanelHandlers();
}
function switchTab(tab){
 $$('#tabs .tab-btn').forEach(b=>{b.setAttribute('aria-selected',b.dataset.tab===tab); b.classList.toggle('btn-primary',b.dataset.tab===tab);});
 $$('#panels .panel').forEach(p=>p.classList.toggle('hidden',p.dataset.panel!==tab));
}
function bindPanelHandlers(){
 $$('[data-add]').forEach(btn=>btn.addEventListener('click',()=>{
  if(!can('تعديل البيانات')) return alert('صلاحية غير كافية.');
  const key=btn.dataset.add; const tab=key.split('::')[1]; const schema=getSchema(tab);
  const row={}; schema.forEach(s=>row[s.name]=prompt('أدخل '+s.label)||'');
  (state.rows[key]=state.rows[key]||[]).push(row); save(); renderTable(key,true); refreshKPIs();
 }));
 $$('[data-export]').forEach(btn=>btn.addEventListener('click',()=>{
  if(!can('توليد التقارير')) return alert('صلاحية غير كافية.');
  const key=btn.dataset.export; const list=state.rows[key]||[]; if(!list.length) return alert('لا توجد بيانات');
  const headers=Object.keys(list[0]).filter(k=>!k.startsWith('_')); const esc=v=>(''+(v??'')).replaceAll('"','""');
  const csv=[headers.map(h=>`"${esc(h)}"`).join(',')].concat(list.map(r=>headers.map(h=>`"${esc(r[h])}"`).join(','))).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=key.replaceAll('::','_')+'.csv'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),500);
 }));
 if($('#rolesSave')){
  $('#rolesSave').addEventListener('click',()=>{save();alert('تم حفظ الصلاحيات');});
  $('#rolesReset').addEventListener('click',()=>{state.roles={map:{}}; ROLES.forEach(r=>{state.roles.map[r]={}; PERMS.forEach(p=>state.roles.map[r][p]=DEFAULT_ROLE_MAP[r].includes(p));}); save(); alert('إعادة الضبط تمت'); buildTabs(state.account);});
  $$('input[type="checkbox"][data-role]').forEach(ch=>ch.addEventListener('change',()=>{const r=ch.dataset.role,p=ch.dataset.perm; state.roles.map[r]=state.roles.map[r]||{}; state.roles.map[r][p]=ch.checked; save();}));
 }
 Object.keys(state.rows).forEach(k=>renderTable(k,false));
}
function renderTable(key,enrich){
 const el=document.getElementById('tbl::'+key); if(!el) return;
 const list=state.rows[key]||[]; const tab=key.split('::')[1]; const schema=getSchema(tab);
 if(enrich&&(tab==='المبادرات'||tab==='المشاريع')){const row=list[list.length-1]; if(row) smartEnrich(row);}
 el.innerHTML=list.length?list.map((r,idx)=>{
  const tds=schema.map(s=>`<td class='py-2'>${r[s.name]||''}</td>`).join('');
  const chip=(tab==='المبادرات'||tab==='المشاريع')?`<div class='mt-1'>${renderSmartChip(r)}</div>`:'';
  const canEdit=can('تعديل البيانات');
  return `<tr><td colspan="100%"><div class="grid md:grid-cols-12 gap-2 items-start">
   <div class="md:col-span-9"><table class="w-full"><tr>${tds}<td class="py-2 flex items-center gap-3">
     <button class="action edit" data-edit="${key}::${idx}" ${!canEdit?'disabled':''}>تعديل</button>
     <button class="action del" data-del="${key}::${idx}" ${!canEdit?'disabled':''}>حذف</button>
   </td></tr></table>${chip}</div>
   <div class="md:col-span-3 hidden md:block"></div>
  </div></td></tr>`;
 }).join(''):`<tr><td class="py-4 text-center text-steel-500" colspan="${schema.length+1}">لا توجد بيانات</td></tr>`;
 $$(`[data-edit^="${key}::"]`).forEach(b=>b.onclick=()=>{ if(!can('تعديل البيانات')) return alert('صلاحية غير كافية.');
  const idx=+b.dataset.edit.split('::').pop(); const row=(state.rows[key]||[])[idx]; if(!row) return;
  const sc=getSchema(tab); sc.forEach(s=>{row[s.name]=prompt('تعديل '+s.label,row[s.name]||'')??row[s.name];});
  if(tab==='المبادرات'||tab==='المشاريع') smartEnrich(row); save(); renderTable(key,false); refreshKPIs();
 });
 $$(`[data-del^="${key}::"]`).forEach(b=>b.onclick=()=>{ if(!can('تعديل البيانات')) return alert('صلاحية غير كافية.');
  const idx=+b.dataset.del.split('::').pop(); if(confirm('تأكيد الحذف؟')){(state.rows[key]||[]).splice(idx,1); save(); renderTable(key,false); refreshKPIs();}
 });
}

function refreshKPIs(){
 const acc=state.account; if(!acc) return;
 let inits=0,ops=0,bal=0,impact=0;
 Object.entries(state.rows).forEach(([k,list])=>{
  if(k.startsWith(acc+'::')){
   if(k.includes('المبادرات')||k.includes('المشاريع')) inits+=list.length;
   if(!k.includes('المحفظة')) ops+=list.length;
   if(k.includes('المؤشرات')||k.includes('تقارير الأثر')) impact+=list.reduce((a,r)=>a+(+r.value||0),0);
  }
 });
 Object.entries(state.rows).forEach(([k,list])=>{if(k===acc+'::المحفظة') bal=list.reduce((a,r)=>a+(+r.amount||0),0);});
 $('#kpiInits').textContent=inits; $('#kpiOps').textContent=ops; $('#kpiBal').textContent=new Intl.NumberFormat('ar-SA').format(bal); $('#kpiImpact').textContent=impact;
}

/* الذكاء المحلي (تصنيف رؤية/مطابقة شركاء/مخاطر مبسطة) */
const VISION_TAGS=[
 {code:'QOL',kw:['جودة الحياة','ثقافة','رياضة','ترفيه','سياحة']},
 {code:'HEALTH',kw:['صحة','مستشفى','علاج','طبي','وقاية']},
 {code:'EDU',kw:['تعليم','مدرسة','تدريب','جامعة','مهارات']},
 {code:'ECON',kw:['وظائف','منشآت','استثمار','ريادة','صناعة']},
 {code:'ENV',kw:['بيئة','تشجير','انبعاث','نظافة','نفايات','مياه']},
 {code:'GOV',kw:['حكومة','تصاريح','تمكين','خدمات','رقمنة']}
];
function classifyVision(text){const t=(text||'').toLowerCase(); const score={}; VISION_TAGS.forEach(p=>{score[p.code]=p.kw.reduce((a,k)=>a+(t.includes(k.toLowerCase())?1:0),0)}); return Object.entries(score).map(([code,s])=>({code,score:s})).filter(x=>x.score>0).sort((a,b)=>b.score-a.score).slice(0,2);}
function matchPartners(project){
 const partners=[{name:'مركز أداء',focus:['GOV','ECON'],regions:'ALL'},
                 {name:'NCDC',focus:['GOV','QOL'],regions:'ALL'},
                 {name:"Monsha'at",focus:['ECON'],regions:'ALL'},
                 {name:'جامعة حائل',focus:['EDU','ENV'],regions:['حائل','المدينة']},
                 {name:'شركة وطنية (CSR)',focus:['QOL','ENV','EDU'],regions:'ALL'}];
 const tags=classifyVision((project.title||'')+' '+(project.note||'')).map(t=>t.code);
 return partners.map(p=>{
  const f=p.focus.some(f=>tags.includes(f))?1:0;
  const r=(p.regions==='ALL'||(project.region&&(p.regions||[]).includes(project.region)))?1:0;
  const b=(project.budget?(project.budget>100000?1:0):0);
  const s=f*0.6+r*0.3+b*0.1; return Object.assign({},p,{score:+s.toFixed(2)});
 }).sort((a,b)=>b.score-a.score);
}
function simpleRisk(project){let r=0; if((project.budget||0)>50000) r+=2; if(/فعالية|تجمع|مهرجان/.test(project.title||'')) r+=1; return {score:r,level:r>=3?'مرتفع':r==2?'متوسط':'منخفض'};}
function smartEnrich(row){row._vision=classifyVision((row.title||'')+' '+(row.note||'')); row._matches=matchPartners({title:row.title,note:row.note,region:row.region,budget:+row.budget||0}); row._risk=simpleRisk({title:row.title,budget:+row.budget||0});}

/* خريطة GeoJSON */
async function tryLoadGeo(){
 const status=$('#geoStatus'), list=$('#geoList'); list.innerHTML=''; status.textContent='محاولة تحميل regions.geojson...';
 try{
  const res=await fetch('./regions.geojson?ts='+(Date.now())); if(!res.ok) throw new Error('HTTP '+res.status);
  const geo=await res.json(); const features=geo.features||[]; if(!features.length){status.textContent='الملف بلا ميزات.';return;}
  status.textContent='تم التحميل: '+features.length+' منطقة.';
  list.innerHTML=features.map((f,i)=>{const n=(f.properties&&(f.properties.name_ar||f.properties.name||f.properties.NAME))||('منطقة #'+(i+1)); return `<button class="rounded-xl border border-steel-200 px-3 py-2 hover:border-brand-600 text-right" data-region="${n}">${n}</button>`;}).join('');
  list.querySelectorAll('button').forEach(btn=>btn.addEventListener('click',()=>{const n=btn.getAttribute('data-region'); $('#selRegion').textContent=n; $('#kpiJobs').textContent=Math.floor(Math.random()*300)+50; $('#kpiGrants').textContent=Math.floor(Math.random()*100)+10; $('#kpiVols').textContent=Math.floor(Math.random()*1000)+100; }));
 }catch(e){ status.textContent='تعذر التحميل. ارفع regions.geojson بجوار index.html.'; }
}
$('#reloadGeo').addEventListener('click',tryLoadGeo);

/* الوثائق/الإعدادات */
async function loadConfigs(){
 const el=$('#cfgList'); el.innerHTML='';
 if(typeof EMBED_BUNDLE==='object'&&EMBED_BUNDLE){
  const names=Object.keys(EMBED_BUNDLE);
  el.innerHTML=names.map(n=>`<li class='rounded-xl border border-steel-200 bg-white px-3 py-2'><div class='font-semibold'>${n}</div><div class='text-xs text-slate-600'>Tabs: ${(EMBED_BUNDLE[n].tabs||[]).length} — Workflow: ${(EMBED_BUNDLE[n].workflow||[]).length} خطوة</div></li>`).join('');
  return;
 }
 try{
  const r=await fetch('./config_accounts_bundle.json?ts='+(Date.now()));
  if(r.ok){
   const bundle=await r.json(); const names=Object.keys(bundle);
   el.innerHTML=names.map(n=>`<li class='rounded-xl border border-steel-200 bg-white px-3 py-2'><div class='font-semibold'>${n}</div><div class='text-xs text-slate-600'>Tabs: ${(bundle[n].tabs||[]).length} — Workflow: ${(bundle[n].workflow||[]).length} خطوة</div></li>`).join('');
   return;
  }
 }catch(_){}
 el.innerHTML=`<li class='text-sm text-steel-600'>لا توجد حزمة خارجية.</li>`;
}
$('#reloadCfg').addEventListener('click',loadConfigs);

/* أدوات الكونسول: ملء/تفريغ/طباعة/سِكِن/داكن/دور */
function seed(){
 if(!state.account) return alert('اختر حساباً أولاً');
 const acc=state.account, push=(tab,rows)=>{state.rows[acc+'::'+tab]=rows;};
 (EMBED_TABS[acc]||[]).forEach(tab=>{
  switch(tab){
   case'المبادرات':case'المشاريع':push(tab,[{title:'مبادرة تشجير الأحياء',owner:acc,budget:'150000',region:'حائل',status:'جارية'},{title:'برنامج تمكين الشباب',owner:acc,budget:'80000',region:'الرياض',status:'مكتملة'}]); break;
   case'الفرص':case'طلبات التمويل':push(tab,[{title:'تمويل منصة تعليمية',cat:'تعليمي',amount:'120000',state:'مفتوحة'}]); break;
   case'الرعايات':push(tab,[{title:'رعاية ملتقى وطني',cat:'فعاليات',amount:'70000',state:'قيد المراجعة'}]); break;
   case'التصاريح':case'التصاريح الأمنية':push(tab,[{org:'جمعية تنموية',type:'فعالية جماهيرية',date:'2025-11-15',status:'معتمد'}]); break;
   case'الفعاليات':push(tab,[{name:'منتدى الابتكار',venue:'قاعة المدينة',date:'2025-12-01',status:'مجدولة'}]); break;
   case'التدريب':case'التدريب التعاوني':push(tab,[{program:'مهارات رقمية',hours:'40',type:'مجتمعي',status:'مفتوح'}]); break;
   case'التطوع':push(tab,[{title:'تنظيم حملة ثقافية',org:'مؤسسة وطنية',hours:'6',date:'2025-10-25'}]); break;
   case'الاستشارات':push(tab,[{topic:'حوكمة جمعيات',benef:'منظمة غير ربحية',date:'2025-11-05',result:'تقرير أولي'}]); break;
   case'المؤشرات':case'تقارير الأثر':push(tab,[{kpi:'عدد المستفيدين',project:'تمكين الشباب',value:'120',unit:'شخص'}]); break;
   case'المحفظة':push(tab,[{benef:'مشروع تمكين الشباب',amount:'200000',kind:'تمويل',note:'دفعة أولى'}]); break;
   case'ESG':push(tab,[{pillar:'E',metric:'انبعاثات CO2',value:'34',unit:'طن'},{pillar:'S',metric:'ساعات تدريب',value:'420',unit:'ساعة'}]); break;
   case'تقارير CSRD':push(tab,[{topic:'E1-Climate',req:'إفصاح الانبعاثات',status:'مسودة',note:'ينقص مراجعة قانونية'}]); break;
   case'التكامل والبيانات':push(tab,[{endpoint:'/api/projects',method:'GET',scope:'قراءة',status:'مفعّل'},{endpoint:'/api/wallet',method:'POST',scope:'تحويل',status:'مقيّد'}]); break;
   default:push(tab,[{title:tab+' — سجل تجريبي',note:'...',date:'2025-10-19',status:'—'}]);
  }
 });
 Object.keys(state.rows).forEach(k=>{if(k.startsWith(acc+'::')&&(k.endsWith('المبادرات')||k.endsWith('المشاريع'))){(state.rows[k]||[]).forEach(smartEnrich);}});
 save(); buildTabs(acc); refreshKPIs();
}
function clearAll(){state={account:state.account,rows:{},roles:state.roles||{},currentRole:state.currentRole||'المشرف العام',session:state.session}; save(); buildTabs(state.account); refreshKPIs();}
$('#seedBtn').addEventListener('click',seed);
$('#clearBtn').addEventListener('click',clearAll);
$('#printBtn')?.addEventListener('click',()=>window.print());
$('#toggleDark').addEventListener('click',()=>{const on=!document.documentElement.hasAttribute('data-theme'); document.documentElement.toggleAttribute('data-theme',on);});
$('#roleSelect').addEventListener('change',e=>{state.currentRole=e.target.value; save(); if(state.account){buildTabs(state.account);}});
document.getElementById('toggleGov')?.addEventListener('click',()=>{const b=document.body; const isGov=b.getAttribute('data-variant')==='gov'; if(isGov)b.removeAttribute('data-variant'); else b.setAttribute('data-variant','gov');});

/* إقلاع الصفحة */
function buildAccountAndMaybeOpen(){
 buildAccountGrid(EMBED_ACCOUNTS);
 if(state.session){$('#logoutBtn').classList.remove('hidden'); $('#fUser').value=state.session.user; $('#fAccount').value=state.session.acc;}
 if(state.session && state.account){openDashboard(state.account);}
}
buildAccountAndMaybeOpen();
</script>

</body>
</html>
